<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <title>Liquidación diaria</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="manifest" href="manifest.json" />
  <meta name="theme-color" content="#FFA500" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black" />
  <meta name="apple-mobile-web-app-title" content="Liquidación diaria" />
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <style>
    :root{
      --coffee:#6f4e37; --orange:#FFA500; --orange-dark:#f0a500;
      --white:#fff; --black:#000; --blue:#008CBA; --neg:#ff6b6b;
    }
    *{box-sizing:border-box}
    html,body{height:100%;margin:0;background:var(--coffee);color:var(--white);font-family:Arial,sans-serif;overscroll-behavior:none}
    .page{min-height:100vh;padding:20px}
    header{
      padding:16px 20px;background:var(--orange);color:var(--white);
      border-radius:8px;margin-bottom:16px;display:flex;align-items:center;justify-content:center;gap:12px
    }
    header img.logo{height:42px;width:auto;border-radius:4px;display:block}
    header h1{margin:0;font-size:1.6em;line-height:1}
    .container{max-width:900px;margin:0 auto}

    .date-input{margin-bottom:16px;display:flex;gap:10px;flex-wrap:wrap;align-items:center}
    .date-input input{
      padding:10px;font-size:1em;border:1px solid var(--white);border-radius:5px;background:transparent;color:var(--white);width:180px
    }

    /* Campos con botones */
    .field{position:relative;flex:1 1 200px;min-width:160px}
    .field input{
      width:100%;padding:10px 72px 10px 10px;font-size:1em;border:1px solid var(--white);border-radius:5px;background:transparent;color:var(--white)
    }
    .field .clear-btn,.field .sign-btn{
      position:absolute;top:50%;transform:translateY(-50%);height:24px;min-width:24px;border:1px solid var(--white);
      color:var(--white);background:transparent;border-radius:50%;cursor:pointer;font-size:16px;display:none;align-items:center;justify-content:center;padding:0
    }
    .field .sign-btn{right:40px;display:inline-flex} /* ± siempre visible */
    .field .clear-btn{right:8px}

    form{display:flex;flex-wrap:wrap;gap:10px;margin-bottom:20px;align-items:center}
    .payment-method{
      display:flex;
      align-items:center;
      gap:12px;
      flex-wrap:wrap;
    }
    .payment-method label{cursor:pointer}
    .pay-row{display:flex;align-items:center;gap:12px;flex-wrap:wrap}
    .pay-row .btn-add-inline{
      padding:10px;font-size:1em;border:1px solid var(--white);
      border-radius:5px;background:var(--blue);color:var(--white);cursor:pointer
    }

    table{width:100%;border-collapse:collapse;margin-bottom:20px;background:#00000022;border-radius:8px;overflow:hidden}
    table,th,td{border:1px solid var(--white)}
    th,td{padding:10px;text-align:center}
    .editBtn{border:1px solid var(--white);background:var(--blue);color:var(--white);border-radius:5px;padding:10px;cursor:pointer}
    .neg{color:var(--neg);font-weight:600}

    /* Colores sutiles por forma de pago */
    .pay-cash td:first-child{border-left:4px solid #7bd389;}
    .pay-card td:first-child{border-left:4px solid #4da6ff;}
    .pay-bizum td:first-child{border-left:4px solid #b084f5;}
    .pay-check td:first-child{border-left:4px solid #f5d76e;}

    .pay-cash td:nth-child(3){color:#7bd389;}
    .pay-card td:nth-child(3){color:#4da6ff;}
    .pay-bizum td:nth-child(3){color:#b084f5;}
    .pay-check td:nth-child(3){color:#f5d76e;}

    .summary{
      display:flex;justify-content:space-around;gap:10px;flex-wrap:wrap;
      padding:10px;background:var(--orange-dark);border:1px solid var(--white);border-radius:5px
    }
    #totalEfectivo,#totalTarjeta,#totalBizum,#totalTalon{
      cursor:pointer;text-decoration:underline
    }
    .totalValue.neg{color:var(--neg)}

    .buttons{display:flex;flex-wrap:wrap;gap:10px;margin-top:10px}
    .buttons button{flex:1;min-width:180px;padding:10px;background:var(--orange);border:none;color:var(--white);border-radius:5px;cursor:pointer}

    footer.footer{
      margin-top:16px;
      padding:6px 10px;
      font-size:0.85em;
      color:#f5f5f5;
      display:flex;
      justify-content:space-between;
      opacity:0.8;
    }

    /* Modales */
    .modal{display:none;position:fixed;inset:0;background:rgba(0,0,0,.5);z-index:1000}
    .modal-content{background:var(--white);color:var(--black);margin:8% auto;padding:20px;border-radius:12px;width:360px;max-width:calc(100% - 24px)}
    .modal-content h2{margin:0 0 12px 0;text-align:center}
    .modal-form{display:grid;grid-template-columns:1fr 1.5fr;gap:10px 12px;align-items:center}
    .modal-form input,.modal-form select{width:100%;padding:8px;border:1px solid #ccc;border-radius:6px}
    @media(max-width:420px){.modal-form{grid-template-columns:1fr}}
    .modal-buttons{margin-top:16px;display:flex;gap:8px;flex-wrap:wrap}
    .modal-buttons button{flex:1;padding:10px;border-radius:8px;border:1px solid #ddd;background:#fff;color:#000}
    .danger{border-color:#d9534f}.primary{border-color:#007bff}.secondary{border-color:#6c757d}

    .dropdown{display:none;margin-top:10px;border:1px solid var(--white);border-radius:5px;padding:10px;background:var(--orange-dark)}
  </style>
</head>
<body>
  <div class="page">
    <header>
      <img src="logo-candelas.jpg" alt="Logo Candelas" class="logo">
      <h1>Liquidación diaria</h1>
    </header>

    <div class="container">
      <!-- Fecha -->
      <div class="date-input">
        <label for="reportDate">Fecha (DD/MM/AAAA):</label>
        <input type="text" id="reportDate" placeholder="DD/MM/AAAA" maxlength="10" inputmode="numeric" autocomplete="off">
      </div>

      <!-- Formulario -->
      <form id="paymentForm" autocomplete="off">
        <div class="field">
          <input type="text" id="clientName" placeholder="Nombre del cliente" autocomplete="off" required>
          <button class="clear-btn" id="clearClient" type="button" aria-label="Limpiar cliente">×</button>
        </div>

        <div class="field">
          <input type="text" id="amount" placeholder="Importe cobrado" autocomplete="off"
                 inputmode="decimal" pattern="-?[0-9]*[.,]?[0-9]*" required>
          <button class="sign-btn" id="toggleSign" type="button" aria-label="Cambiar signo">±</button>
          <button class="clear-btn" id="clearAmount" type="button" aria-label="Limpiar importe">×</button>
        </div>

        <!-- Formas de pago + Agregar EN LA MISMA LÍNEA -->
        <div class="pay-row">
          <div class="payment-method">
            <label><input type="radio" name="paymentType" value="Efectivo"> Efectivo</label>
            <label><input type="radio" name="paymentType" value="Tarjeta"> Tarjeta</label>
            <label><input type="radio" name="paymentType" value="Bizum"> Bizum</label>
            <label><input type="radio" name="paymentType" value="Talón"> Talón</label>
          </div>
          <button class="btn-add-inline" type="submit">Agregar</button>
        </div>
      </form>

      <!-- Tabla -->
      <table id="historyTable">
        <thead>
          <tr><th>Cliente</th><th>Importe</th><th>Forma de pago</th><th>Acciones</th></tr>
        </thead>
        <tbody></tbody>
      </table>

      <!-- Resumen -->
      <div class="summary">
        <div><strong>Efectivo:</strong> <span id="totalEfectivo" class="totalValue">0,00</span></div>
        <div><strong>Tarjeta:</strong> <span id="totalTarjeta" class="totalValue">0,00</span></div>
        <div><strong>Bizum:</strong> <span id="totalBizum" class="totalValue">0,00</span></div>
        <div><strong>Talón:</strong> <span id="totalTalon" class="totalValue">0,00</span></div>
        <div><strong>Total:</strong> <span id="totalGeneral" class="totalValue">0,00</span></div>
      </div>

      <!-- Dropdowns -->
      <div id="dropdownEfectivo" class="dropdown"></div>
      <div id="dropdownTarjeta" class="dropdown"></div>
      <div id="dropdownBizum" class="dropdown"></div>
      <div id="dropdownTalon" class="dropdown"></div>

      <!-- Botones -->
      <div class="buttons">
        <button id="downloadExcel">Descargar / Compartir Excel</button>
        <button id="clearHistory">Borrar Historial</button>
      </div>

      <!-- Versión -->
      <footer class="footer">
        <span>Versión <span id="appVersion"></span></span>
        <span id="appRevision"></span>
      </footer>
    </div>
  </div>

  <!-- Modal edición -->
  <div id="editModal" class="modal">
    <div class="modal-content">
      <h2>Editar entrada</h2>
      <div class="modal-form">
        <label for="editClient">Cliente</label>
        <input type="text" id="editClient" />
        <label for="editAmount">Importe</label>
        <input type="text" id="editAmount" inputmode="decimal" pattern="-?[0-9]*[.,]?[0-9]*" />
        <label for="editPayment">Forma de pago</label>
        <select id="editPayment">
          <option value="Efectivo">Efectivo</option>
          <option value="Tarjeta">Tarjeta</option>
          <option value="Bizum">Bizum</option>
          <option value="Talón">Talón</option>
        </select>
      </div>
      <div class="modal-buttons">
        <button id="deleteLine" class="danger">Eliminar línea</button>
        <button id="saveEdit" class="primary">Guardar</button>
        <button id="cancelEdit" class="secondary">Cancelar</button>
      </div>
    </div>
  </div>

  <!-- Confirmación -->
  <div id="confirmModal" class="modal">
    <div class="modal-content">
      <p id="confirmMessage">¿Seguro?</p>
      <div class="modal-buttons">
        <button id="confirmAccept" class="primary">Aceptar</button>
        <button id="confirmCancel" class="secondary">Cancelar</button>
      </div>
    </div>
  </div>

  <!-- Alerta -->
  <div id="alertModal" class="modal">
    <div class="modal-content">
      <p id="alertMessage">Mensaje</p>
      <div class="modal-buttons">
        <button id="alertAccept" class="primary">Aceptar</button>
      </div>
    </div>
  </div>

<script>
/* === Versión automática basada en fecha/hora del fichero === */
const APP_BASE_VERSION = '1.3'; // Cambia esto cuando haya cambios "gordos"

function computeAppVersion() {
  const d = new Date(document.lastModified || Date.now());
  const yy = String(d.getFullYear()).slice(-2);
  const mm = String(d.getMonth() + 1).padStart(2,'0');
  const dd = String(d.getDate()).padStart(2,'0');
  const hh = String(d.getHours()).padStart(2,'0');
  const min = String(d.getMinutes()).padStart(2,'0');
  return `${APP_BASE_VERSION}.${yy}${mm}${dd}${hh}${min}`;
}
const APP_VERSION = computeAppVersion();

/* === Helpers === */
const $=s=>document.querySelector(s); const $$=s=>Array.from(document.querySelectorAll(s));
function formatNumber(n){return Number(n||0).toFixed(2).replace('.',',');}
function parseAmount(v){
  if(v==null)return NaN;
  const c=String(v).trim().replace(',', '.');
  if(!/^[-+]?\d*\.?\d*$/.test(c)) return NaN;
  return parseFloat(c);
}
function setNegColor(el,v){Number(v)<0?el.classList.add('neg'):el.classList.remove('neg');}

/* === Estado === */
let historyData=[];let currentEditIndex=null;let revision=0;

function loadHistory(){
  try{
    historyData=JSON.parse(localStorage.getItem('history')||'[]');
    if(!Array.isArray(historyData))historyData=[];
  }catch{historyData=[]}

  const storedVersion = localStorage.getItem('appVersion');

  // Si cambia la versión de app, reseteamos revisión
  if(storedVersion !== APP_VERSION){
    revision = 0;
    localStorage.setItem('appVersion', APP_VERSION);
    localStorage.setItem('dataRevision', String(revision));
  } else {
    revision = Number(localStorage.getItem('dataRevision')||'0')||0;
  }
}
function saveHistory(){localStorage.setItem('history',JSON.stringify(historyData));}
function updateVersionUI(){
  const vEl = $('#appVersion');
  const rEl = $('#appRevision');
  if(vEl) vEl.textContent = APP_VERSION;
  if(rEl) rEl.textContent = 'Rev. '+revision;
}
function bumpRevision(){
  revision++;
  localStorage.setItem('dataRevision', String(revision));
  updateVersionUI();
}
function clearNode(n){while(n.firstChild)n.removeChild(n.firstChild);}

/* === UI === */
function updateUI(){
  const tb=$('#historyTable tbody');clearNode(tb);
  let tE=0,tT=0,tB=0,tL=0;

  const typeClasses = {
    'Efectivo':'pay-cash',
    'Tarjeta':'pay-card',
    'Bizum':'pay-bizum',
    'Talón':'pay-check'
  };

  historyData.forEach((e,i)=>{
    const tr=document.createElement('tr');
    const tdC=document.createElement('td');tdC.textContent=e.client;
    const tdA=document.createElement('td');tdA.textContent=formatNumber(e.amount);setNegColor(tdA,e.amount);
    const tdT=document.createElement('td');tdT.textContent=e.type;
    const tdAct=document.createElement('td');const btn=document.createElement('button');
    btn.type='button';btn.className='editBtn';btn.textContent='Editar';btn.dataset.i=i;
    tdAct.appendChild(btn);
    tr.append(tdC,tdA,tdT,tdAct);

    const cls = typeClasses[e.type];
    if(cls) tr.classList.add(cls);

    tb.appendChild(tr);

    switch(e.type){
      case 'Efectivo': tE+=+e.amount; break;
      case 'Tarjeta': tT+=+e.amount; break;
      case 'Bizum':   tB+=+e.amount; break;
      case 'Talón':   tL+=+e.amount; break;
    }
  });

  const elTE=$('#totalEfectivo'),
        elTT=$('#totalTarjeta'),
        elTB=$('#totalBizum'),
        elTL=$('#totalTalon'),
        elTG=$('#totalGeneral');

  elTE.textContent=formatNumber(tE); setNegColor(elTE,tE);
  elTT.textContent=formatNumber(tT); setNegColor(elTT,tT);
  elTB.textContent=formatNumber(tB); setNegColor(elTB,tB);
  elTL.textContent=formatNumber(tL); setNegColor(elTL,tL);

  const totalGeneral = tE+tT+tB+tL;
  elTG.textContent=formatNumber(totalGeneral); setNegColor(elTG,totalGeneral);

  $$('.editBtn').forEach(b=>b.onclick=()=>{currentEditIndex=+b.dataset.i;openEditModal(currentEditIndex);});
}

/* === Modales === */
function customConfirm(msg,cb){
  $('#confirmMessage').textContent=msg;
  const m=$('#confirmModal');m.style.display='block';
  const a=$('#confirmAccept'),c=$('#confirmCancel');
  function clean(){a.onclick=c.onclick=null;m.style.display='none'}
  a.onclick=()=>{clean();cb(true)};
  c.onclick=()=>{clean();cb(false)};
}
function customAlert(msg,cb){
  $('#alertMessage').textContent=msg;
  const m=$('#alertModal');m.style.display='block';
  $('#alertAccept').onclick=()=>{m.style.display='none';if(cb)cb();};
}

function openEditModal(i){
  const e=historyData[i]; if(!e) return;
  $('#editClient').value=e.client;
  $('#editAmount').value=e.amount;
  $('#editPayment').value=e.type;
  $('#editModal').style.display='block';
}
function closeEditModal(){$('#editModal').style.display='none';currentEditIndex=null;}

$('#saveEdit').onclick=()=>{
  const c=$('#editClient').value.trim();
  const a=parseAmount($('#editAmount').value);
  const t=$('#editPayment').value;
  if(!c||isNaN(a)){customAlert('Datos inválidos');return;}
  historyData[currentEditIndex]={client:c,amount:a,type:t};
  saveHistory();updateUI();closeEditModal();bumpRevision();
};
$('#cancelEdit').onclick=closeEditModal;
$('#deleteLine').onclick=()=>{
  const e=historyData[currentEditIndex]; if(!e) return;
  customConfirm(`¿Eliminar "${e.client}" (${formatNumber(e.amount)} - ${e.type})?`, ok=>{
    if(!ok) return;
    historyData.splice(currentEditIndex,1);
    saveHistory(); updateUI(); closeEditModal(); bumpRevision();
  });
};

/* === Formulario === */
const clientInput=$('#clientName'); const amountInput=$('#amount');
const clearClientBtn=$('#clearClient'); const clearAmountBtn=$('#clearAmount'); const toggleSignBtn=$('#toggleSign');

function toggleClearBtn(i,b){b.style.display=i.value?'inline-flex':'none';}
clientInput.oninput=()=>toggleClearBtn(clientInput,clearClientBtn);
amountInput.oninput=()=>toggleClearBtn(amountInput,clearAmountBtn);
clearClientBtn.onclick=()=>{clientInput.value='';toggleClearBtn(clientInput,clearClientBtn);clientInput.focus();}
clearAmountBtn.onclick=()=>{amountInput.value='';toggleClearBtn(amountInput,clearAmountBtn);amountInput.focus();}
toggleSignBtn.onclick=()=>{
  let v=amountInput.value.trim();
  if(!v){amountInput.value='-';amountInput.focus();return;}
  amountInput.value=v.startsWith('-')?v.slice(1):'-'+v;
  amountInput.focus(); toggleClearBtn(amountInput,clearAmountBtn);
};

$('#paymentForm').onsubmit=e=>{
  e.preventDefault();
  const c=clientInput.value.trim();
  const a=parseAmount(amountInput.value);
  const t=document.querySelector('input[name="paymentType"]:checked')?.value;
  if(!c||isNaN(a)||!t){customAlert('Faltan datos válidos');return;}
  historyData.push({client:c,amount:a,type:t});
  saveHistory(); updateUI(); bumpRevision();

  // Reset y ocultar teclado
  e.target.reset();
  clientInput.value=''; amountInput.value='';
  toggleClearBtn(clientInput,clearClientBtn); toggleClearBtn(amountInput,clearAmountBtn);

  clientInput.blur(); amountInput.blur();
  if (document.activeElement && typeof document.activeElement.blur === 'function') {
    document.activeElement.blur();
  }
};

/* === Borrar historial === */
$('#clearHistory').onclick=()=>customConfirm('¿Borrar historial?', ok=>{
  if(ok){
    historyData=[];saveHistory();updateUI();bumpRevision();
  }
});

/* === Máscara de fecha === */
$('#reportDate').addEventListener('input',function(){
  let v=this.value.replace(/\D/g,'');
  if(v.length>2&&v.length<=4) v=v.slice(0,2)+'/'+v.slice(2);
  else if(v.length>4) v=v.slice(0,2)+'/'+v.slice(2,4)+'/'+v.slice(4,8);
  this.value=v;
});

/* === Descargar / Compartir Excel: bloques por forma de pago, totales debajo, sin símbolo € === */
function isShareSupported(file){return navigator.share&&navigator.canShare&&navigator.canShare({files:[file]});}
$('#downloadExcel').onclick=async()=>{
  const d=$('#reportDate').value.trim();
  if(!/^\d{2}\/\d{2}\/\d{4}$/.test(d)){
    customAlert('Fecha inválida. Formato: DD/MM/AAAA.');
    return;
  }

  const allTypes = ['Efectivo','Tarjeta','Bizum','Talón'];
  const activeTypes = allTypes.filter(type => historyData.some(e=>e.type===type));

  if(activeTypes.length===0){
    customAlert('No hay datos para exportar.');
    return;
  }

  // Grupos por tipo y totales
  const groups = {};
  const totals = {};
  activeTypes.forEach(type=>{
    const list = historyData.filter(e=>e.type===type);
    groups[type] = list;
    totals[type] = list.reduce((s,e)=>s+(+e.amount||0),0);
  });
  const totalGeneral = activeTypes.reduce((s,type)=>s+totals[type],0);

  const ws_data = [];

  // Título y fecha
  ws_data.push(['Liquidación diaria']);
  ws_data.push(['Fecha: '+d]);
  ws_data.push([]);

  // Fila de títulos de tipo de pago (Efectivo, Tarjeta, ...)
  const typeRow = [];
  activeTypes.forEach(type=>{
    typeRow.push(type,'');
  });
  ws_data.push(typeRow);

  // Fila de cabeceras Cliente / Importe
  const headerRow = [];
  activeTypes.forEach(()=>{
    headerRow.push('Cliente','Importe');
  });
  ws_data.push(headerRow);

  // Filas de datos
  const maxLen = Math.max(...activeTypes.map(t=>groups[t].length));
  for(let i=0;i<maxLen;i++){
    const row = [];
    activeTypes.forEach(type=>{
      const item = groups[type][i];
      if(item){
        row.push(item.client, Number(item.amount));
      }else{
        row.push('',''); // nada, para evitar ceros
      }
    });
    ws_data.push(row);
  }

  // Fila en blanco
  ws_data.push([]);

  // Fila de totales por tipo
  const totalsRow = [];
  activeTypes.forEach(type=>{
    totalsRow.push('Total '+type, Number(totals[type]));
  });
  ws_data.push(totalsRow);

  // Fila de Total General (debajo, en primera pareja de columnas)
  const totalGeneralRow = [];
  totalGeneralRow.push('Total General', Number(totalGeneral));
  // resto vacío
  for(let i=2;i<activeTypes.length*2;i++){
    totalGeneralRow.push('');
  }
  ws_data.push(totalGeneralRow);

  // Crear libro/hoja
  const wb=XLSX.utils.book_new();
  const ws=XLSX.utils.aoa_to_sheet(ws_data);

  const totalCols = activeTypes.length*2;

  // Anchos de columnas: cliente grande, importe más pequeño
  const cols=[];
  for(let i=0;i<totalCols;i++){
    cols.push({wch: i%2===0 ? 18 : 12});
  }
  ws['!cols']=cols;

  // Índices
  const typeRowIndex = 3;
  const headerRowIndex = 4;
  const dataStartRowIndex = 5;
  const totalsRowIndex = dataStartRowIndex + maxLen + 1; // después de datos + fila en blanco
  const totalGeneralRowIndex = totalsRowIndex + 1;

  // Merges: título, fecha, y nombres de tipo sobre sus dos columnas
  const merges = [
    {s:{r:0,c:0},e:{r:0,c:totalCols-1}},
    {s:{r:1,c:0},e:{r:1,c:totalCols-1}}
  ];
  activeTypes.forEach((type,idx)=>{
    const startCol = idx*2;
    merges.push({s:{r:typeRowIndex,c:startCol},e:{r:typeRowIndex,c:startCol+1}});
  });
  ws['!merges']=merges;

  // Estilos básicos
  function styleRow(r, {bold=false, center=false, fillColor=null}={}){
    for(let c=0;c<totalCols;c++){
      const addr = XLSX.utils.encode_cell({r,c});
      const cell = ws[addr];
      if(!cell) continue;
      cell.s = cell.s || {};
      if(bold){
        cell.s.font = Object.assign({}, cell.s.font, {bold:true});
      }
      if(center){
        cell.s.alignment = Object.assign({}, cell.s.alignment, {horizontal:"center"});
      }
      if(fillColor){
        cell.s.fill = {
          patternType: "solid",
          fgColor: {rgb: fillColor}
        };
      }
    }
  }

  styleRow(0, {bold:true, center:true});   // título
  styleRow(1, {center:true});              // fecha
  styleRow(typeRowIndex, {
    bold:true,
    center:true,
    fillColor:'FFF3CD'                     // cabecera tipos
  });
  styleRow(headerRowIndex, {
    bold:true,
    center:true,
    fillColor:'DDEBF7'                     // cabeceras Cliente/Importe
  });
  styleRow(totalsRowIndex, {bold:true});
  styleRow(totalGeneralRowIndex, {bold:true});

  // NO ponemos formato de moneda: los números se quedan limpios para copiar/pegar

  XLSX.utils.book_append_sheet(wb,ws,'Historial');

  const blob=new Blob(
    [XLSX.write(wb,{bookType:'xlsx',type:'array',cellStyles:true})],
    {type:'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet'}
  );
  const fileName='liquidacion_'+d.replace(/\//g,'-')+'.xlsx';
  const file=new File([blob],fileName,{type:blob.type});

  try{
    if(isShareSupported(file)){
      await navigator.share({files:[file],title:'Liquidación diaria',text:fileName});
      return;
    }
  }catch(_){
    // Si cancela el share, seguimos a descarga
  }

  const url=URL.createObjectURL(blob);
  const a=document.createElement('a'); a.href=url; a.download=fileName; a.click();
  setTimeout(()=>URL.revokeObjectURL(url),1500);
};

/* === Dropdowns === */
function fillDropdown(list,node){
  clearNode(node);
  if(!list.length){
    const em=document.createElement('em');
    em.textContent='Sin registros.';
    node.appendChild(em);
    return;
  }
  const ul=document.createElement('ul');
  ul.style.listStyle='none';
  ul.style.margin='0';
  ul.style.padding='0';
  list.forEach(it=>{
    const li=document.createElement('li');
    const span=document.createElement('span');
    span.textContent=`${it.client} — ${formatNumber(it.amount)}`;
    if(Number(it.amount)<0) span.classList.add('neg');
    li.appendChild(span);
    ul.appendChild(li);
  });
  node.appendChild(ul);
}
function hideAllDropdowns(){
  ['dropdownEfectivo','dropdownTarjeta','dropdownBizum','dropdownTalon'].forEach(id=>{
    const el=document.getElementById(id);
    if(el) el.style.display='none';
  });
}

$('#totalEfectivo').onclick=()=>{
  const d=$('#dropdownEfectivo');
  const isOpen=d.style.display==='block';
  hideAllDropdowns();
  if(!isOpen){
    fillDropdown(historyData.filter(e=>e.type==='Efectivo'), d);
    d.style.display='block';
  }
};
$('#totalTarjeta').onclick=()=>{
  const d=$('#dropdownTarjeta');
  const isOpen=d.style.display==='block';
  hideAllDropdowns();
  if(!isOpen){
    fillDropdown(historyData.filter(e=>e.type==='Tarjeta'), d);
    d.style.display='block';
  }
};
$('#totalBizum').onclick=()=>{
  const d=$('#dropdownBizum');
  const isOpen=d.style.display==='block';
  hideAllDropdowns();
  if(!isOpen){
    fillDropdown(historyData.filter(e=>e.type==='Bizum'), d);
    d.style.display='block';
  }
};
$('#totalTalon').onclick=()=>{
  const d=$('#dropdownTalon');
  const isOpen=d.style.display==='block';
  hideAllDropdowns();
  if(!isOpen){
    fillDropdown(historyData.filter(e=>e.type==='Talón'), d);
    d.style.display='block';
  }
};

/* === Start === */
loadHistory();
updateUI();
updateVersionUI();
toggleClearBtn($('#clientName'), $('#clearClient'));
toggleClearBtn($('#amount'), $('#clearAmount'));
</script>
</body>
</html>
