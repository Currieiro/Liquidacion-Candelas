<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <title>Liquidación diaria</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="manifest" href="manifest.json" />
  <meta name="theme-color" content="#FFA500" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black" />
  <meta name="apple-mobile-web-app-title" content="Liquidación diaria" />
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <style>
    /* ======================== */
    /* Estilos generales y de layout */
    /* ======================== */
    :root {
      --coffee: #6f4e37;
      --orange: #FFA500;
      --orange-dark: #f0a500;
      --white: #fff;
      --text: #fff;
      --black: #000;
    }
    * { box-sizing: border-box; }
    body {
      font-family: Arial, sans-serif;
      background: var(--coffee);
      color: var(--text);
      margin: 0;
      padding: 20px;
    }
    header {
      text-align: center;
      padding: 20px;
      background-color: var(--orange);
      color: var(--white);
      border-radius: 8px;
      margin-bottom: 16px;
    }
    .container {
      max-width: 900px;
      margin: 0 auto;
    }
    .date-input {
      margin-bottom: 20px;
      display: flex;
      align-items: center;
      gap: 10px;
      flex-wrap: wrap;
    }
    .date-input input {
      padding: 10px;
      font-size: 1em;
      border: 1px solid var(--white);
      border-radius: 5px;
      background: transparent;
      color: var(--white);
      width: 180px;
    }
    form {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      margin-bottom: 20px;
    }
    form input,
    form button,
    form select {
      padding: 10px;
      font-size: 1em;
      border: 1px solid var(--white);
      border-radius: 5px;
      background: transparent;
      color: var(--white);
    }
    form input[type="text"],
    form input[type="number"] {
      flex: 1 1 200px;
      min-width: 160px;
    }
    .payment-method {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 8px 12px;
      border: 1px dashed #ffffff66;
      border-radius: 6px;
    }
    .payment-method label { cursor: pointer; }
    form button[type="submit"] {
      background-color: #008CBA;
      color: var(--white);
      border: 1px solid var(--white);
      border-radius: 5px;
      cursor: pointer;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      margin-bottom: 20px;
      background: #00000022;
      border-radius: 8px;
      overflow: hidden;
    }
    table, th, td { border: 1px solid var(--white); }
    th, td { padding: 10px; text-align: center; }
    th.acciones { width: 140px; }
    .summary {
      display: flex;
      justify-content: space-around;
      gap: 10px;
      flex-wrap: wrap;
      padding: 10px;
      background-color: var(--orange-dark);
      border: 1px solid var(--white);
      border-radius: 5px;
    }
    .summary div { color: var(--white); }
    #totalEfectivo, #totalTarjeta { cursor: pointer; text-decoration: underline; }
    .buttons {
      display: flex;
      justify-content: space-between;
      margin-top: 10px;
      gap: 10px;
      flex-wrap: wrap;
    }
    .buttons button {
      flex: 1;
      min-width: 180px;
      margin: 5px 0;
      padding: 10px;
      background-color: var(--orange);
      border: none;
      color: var(--white);
      border-radius: 5px;
      cursor: pointer;
    }
    .buttons button:hover { opacity: 0.9; }

    /* ======================== */
    /* Estilos para los modales */
    /* ======================== */
    .modal {
      display: none;
      position: fixed;
      z-index: 1000;
      inset: 0;
      width: 100%;
      height: 100%;
      overflow: auto;
      background-color: rgba(0,0,0,0.5);
    }
    .modal-content {
      background-color: var(--white);
      color: var(--black);
      margin: 8% auto;
      padding: 20px;
      border: 1px solid #888;
      width: 320px;
      max-width: calc(100% - 24px);
      border-radius: 8px;
      text-align: center;
    }
    .modal-content h2 { margin: 0 0 6px 0; }
    .modal-content label {
      display: block;
      margin-top: 10px;
      font-weight: bold;
      text-align: left;
    }
    .modal-content input, .modal-content select {
      width: 100%;
      padding: 8px;
      margin-top: 5px;
      border: 1px solid #ccc;
      border-radius: 6px;
    }
    .modal-buttons {
      margin-top: 16px;
      display: flex;
      gap: 8px;
      justify-content: space-between;
      flex-wrap: wrap;
    }
    .modal-buttons button {
      padding: 8px 10px;
      cursor: pointer;
      flex: 1;
      border-radius: 6px;
      border: 1px solid #ddd;
      background: #f3f3f3;
    }
    .danger { background: #d9534f; color: #fff; border-color: #d9534f; }
    .primary { background: #007bff; color: #fff; border-color: #007bff; }
    .secondary { background: #6c757d; color: #fff; border-color: #6c757d; }

    /* Dropdowns */
    .dropdown {
      display:none;
      margin-top: 10px;
      border: 1px solid var(--white);
      border-radius: 5px;
      padding: 10px;
      background-color: var(--orange-dark);
      color: var(--white);
    }
    .muted { opacity: .9; font-size: .9em; }
  </style>
</head>
<body>
  <header>
    <h1>Liquidación diaria</h1>
  </header>

  <div class="container">
    <!-- Campo de fecha -->
    <div class="date-input">
      <label for="reportDate">Fecha (DD/MM/AAAA):</label>
      <input type="text" id="reportDate" placeholder="DD/MM/AAAA" maxlength="10" autocomplete="off" inputmode="numeric">
      <span class="muted">La fecha y el formulario se guardan como borrador automáticamente.</span>
    </div>

    <!-- Formulario de entrada -->
    <form id="paymentForm" autocomplete="off">
      <input type="text" id="clientName" placeholder="Nombre del cliente" required autocomplete="off">
      <input type="number" id="amount" placeholder="Importe cobrado" required step="0.01" inputmode="decimal" autocomplete="off">
      <div class="payment-method">
        <label><input type="radio" name="paymentType" value="Efectivo"> Efectivo</label>
        <label><input type="radio" name="paymentType" value="Tarjeta"> Tarjeta</label>
      </div>
      <button type="submit">Agregar</button>
    </form>

    <!-- Tabla de historial -->
    <table id="historyTable">
      <thead>
        <tr>
          <th>Cliente</th>
          <th>Importe</th>
          <th>Forma de pago</th>
          <th class="acciones">Acciones</th>
        </tr>
      </thead>
      <tbody><!-- filas dinámicas --></tbody>
    </table>

    <!-- Resumen -->
    <div class="summary">
      <div><strong>Total Efectivo:</strong> <span id="totalEfectivo">0,00</span></div>
      <div><strong>Total Tarjeta:</strong> <span id="totalTarjeta">0,00</span></div>
      <div><strong>Total General:</strong> <span id="totalGeneral">0,00</span></div>
    </div>

    <!-- Dropdowns -->
    <div id="dropdownEfectivo" class="dropdown"></div>
    <div id="dropdownTarjeta" class="dropdown"></div>

    <!-- Botones -->
    <div class="buttons">
      <button id="downloadExcel">Descargar Excel</button>
      <button id="clearHistory">Borrar Historial</button>
    </div>
  </div>

  <!-- Modal edición -->
  <div id="editModal" class="modal" aria-hidden="true">
    <div class="modal-content">
      <h2>Editar entrada</h2>
      <label for="editClient">Cliente</label>
      <input type="text" id="editClient" />
      <label for="editAmount">Importe</label>
      <input type="number" id="editAmount" step="0.01" inputmode="decimal" />
      <label for="editPayment">Forma de pago</label>
      <select id="editPayment">
        <option value="Efectivo">Efectivo</option>
        <option value="Tarjeta">Tarjeta</option>
      </select>
      <div class="modal-buttons">
        <button id="deleteLine" class="danger">Eliminar línea</button>
        <button id="saveEdit" class="primary">Guardar</button>
        <button id="cancelEdit" class="secondary">Cancelar</button>
      </div>
    </div>
  </div>

  <!-- Modal confirmación -->
  <div id="confirmModal" class="modal" aria-hidden="true">
    <div class="modal-content">
      <p id="confirmMessage">Mensaje de confirmación</p>
      <div class="modal-buttons">
        <button id="confirmAccept" class="primary">Aceptar</button>
        <button id="confirmCancel" class="secondary">Cancelar</button>
      </div>
    </div>
  </div>

  <!-- Modal alerta -->
  <div id="alertModal" class="modal" aria-hidden="true">
    <div class="modal-content">
      <p id="alertMessage">Mensaje de alerta</p>
      <div class="modal-buttons">
        <button id="alertAccept" class="primary">Aceptar</button>
      </div>
    </div>
  </div>

  <script>
    // ============================
    // Utilidades
    // ============================
    const LS_KEYS = {
      HISTORY: 'history',
      DRAFT: 'draft_paymentForm',
      DATE: 'draft_reportDate'
    };

    const $ = (sel, ctx = document) => ctx.querySelector(sel);
    const $$ = (sel, ctx = document) => Array.from(ctx.querySelectorAll(sel));

    function formatNumber(num) {
      // Asegura 2 decimales y coma en UI
      const n = (typeof num === 'number') ? num : parseFloat(String(num).replace(',', '.')) || 0;
      return n.toFixed(2).replace('.', ',');
    }

    function parseAmount(input) {
      // Acepta "12,34" o "12.34"
      if (input == null) return NaN;
      return parseFloat(String(input).replace(',', '.'));
    }

    // ============================
    // Estado y persistencia
    // ============================
    let history = [];
    let currentEditIndex = null; // índice de la entrada a editar en history

    function loadHistory() {
      try {
        const raw = localStorage.getItem(LS_KEYS.HISTORY);
        history = raw ? JSON.parse(raw) : [];
        if (!Array.isArray(history)) history = [];
      } catch (e) {
        history = [];
      }
    }

    function saveHistory() {
      localStorage.setItem(LS_KEYS.HISTORY, JSON.stringify(history));
    }

    // Borradores: nunca perdemos lo tecleado salvo que el usuario lo cambie
    function saveDraftForm() {
      const draft = {
        client: $('#clientName').value,
        amount: $('#amount').value, // guardo tal cual lo tecleado (coma o punto)
        type: ($('input[name="paymentType"]:checked') || {}).value || null
      };
      localStorage.setItem(LS_KEYS.DRAFT, JSON.stringify(draft));
    }

    function loadDraftForm() {
      try {
        const raw = localStorage.getItem(LS_KEYS.DRAFT);
        if (!raw) return;
        const draft = JSON.parse(raw);
        if (draft.client != null) $('#clientName').value = draft.client;
        if (draft.amount != null) $('#amount').value = draft.amount;
        if (draft.type) {
          const r = document.querySelector(`input[name="paymentType"][value="${draft.type}"]`);
          if (r) r.checked = true;
        }
      } catch (_) {}
    }

    function saveDraftDate() {
      localStorage.setItem(LS_KEYS.DATE, $('#reportDate').value);
    }

    function loadDraftDate() {
      const d = localStorage.getItem(LS_KEYS.DATE);
      if (d) $('#reportDate').value = d;
    }

    // ============================
    // UI
    // ============================
    function clearNode(node) {
      while (node.firstChild) node.removeChild(node.firstChild);
    }

    function makeCell(text) {
      const td = document.createElement('td');
      td.textContent = text;
      return td;
    }

    function updateUI() {
      const tbody = $('#historyTable tbody');
      clearNode(tbody);

      let totalEfectivo = 0;
      let totalTarjeta = 0;

      history.forEach((entry, index) => {
        const tr = document.createElement('tr');

        tr.appendChild(makeCell(entry.client));
        tr.appendChild(makeCell(formatNumber(entry.amount)));
        tr.appendChild(makeCell(entry.type));

        const tdAcc = document.createElement('td');
        const btnEdit = document.createElement('button');
        btnEdit.type = 'button';
        btnEdit.className = 'editBtn';
        btnEdit.textContent = 'Editar';
        btnEdit.dataset.index = String(index);
        tdAcc.appendChild(btnEdit);
        tr.appendChild(tdAcc);

        tbody.appendChild(tr);

        if (entry.type === 'Efectivo') totalEfectivo += Number(entry.amount) || 0;
        else totalTarjeta += Number(entry.amount) || 0;
      });

      $('#totalEfectivo').textContent = formatNumber(totalEfectivo);
      $('#totalTarjeta').textContent = formatNumber(totalTarjeta);
      $('#totalGeneral').textContent = formatNumber(totalEfectivo + totalTarjeta);

      // Bind edición
      $$('.editBtn').forEach(btn => {
        btn.addEventListener('click', () => {
          currentEditIndex = parseInt(btn.dataset.index, 10);
          openEditModal(currentEditIndex);
        });
      });
    }

    // ============================
    // Modales custom
    // ============================
    function customConfirm(message, callback) {
      const modal = $('#confirmModal');
      $('#confirmMessage').textContent = message;
      modal.style.display = 'block';

      const acceptBtn = $('#confirmAccept');
      const cancelBtn = $('#confirmCancel');

      function clean() {
        acceptBtn.removeEventListener('click', onAccept);
        cancelBtn.removeEventListener('click', onCancel);
        modal.style.display = 'none';
      }
      function onAccept() { clean(); callback(true); }
      function onCancel() { clean(); callback(false); }

      acceptBtn.addEventListener('click', onAccept);
      cancelBtn.addEventListener('click', onCancel);
    }

    function customAlert(message, callback) {
      const modal = $('#alertModal');
      $('#alertMessage').textContent = message;
      modal.style.display = 'block';

      const acceptBtn = $('#alertAccept');
      function onAccept() {
        acceptBtn.removeEventListener('click', onAccept);
        modal.style.display = 'none';
        if (callback) callback();
      }
      acceptBtn.addEventListener('click', onAccept);
    }

    // ============================
    // Modal edición
    // ============================
    function openEditModal(index) {
      const entry = history[index];
      if (!entry) return;
      $('#editClient').value = entry.client;
      $('#editAmount').value = String(entry.amount);
      $('#editPayment').value = entry.type;
      $('#editModal').style.display = 'block';
    }
    function closeEditModal() {
      $('#editModal').style.display = 'none';
      currentEditIndex = null;
    }

    $('#saveEdit').addEventListener('click', () => {
      const newClient = $('#editClient').value.trim();
      const newAmount = parseAmount($('#editAmount').value);
      const newPayment = $('#editPayment').value;

      if (!newClient || isNaN(newAmount)) {
        customAlert('Por favor, ingresa datos válidos.', () => {});
        return;
      }
      history[currentEditIndex].client = newClient;
      history[currentEditIndex].amount = newAmount;
      history[currentEditIndex].type = newPayment;
      saveHistory();
      updateUI();
      closeEditModal();
    });

    $('#cancelEdit').addEventListener('click', closeEditModal);

    // Botón eliminar línea dentro del modal de edición
    $('#deleteLine').addEventListener('click', () => {
      const entry = history[currentEditIndex];
      if (!entry) return;
      customConfirm(`¿Eliminar la línea de "${entry.client}" (${formatNumber(entry.amount)} - ${entry.type})?`, (ok) => {
        if (!ok) return;
        history.splice(currentEditIndex, 1);
        saveHistory();
        updateUI();
        closeEditModal();
      });
    });

    // ============================
    // Inicialización
    // ============================
    loadHistory();
    loadDraftForm();
    loadDraftDate();
    updateUI();

    // ============================
    // Formulario: guardado y envío
    // ============================
    // Guardado de borrador continuo (no se pierde lo tecleado)
    $('#clientName').addEventListener('input', saveDraftForm);
    $('#amount').addEventListener('input', saveDraftForm);
    $$('input[name="paymentType"]').forEach(r => r.addEventListener('change', saveDraftForm));
    $('#reportDate').addEventListener('input', saveDraftDate);

    // Máscara de fecha
    $('#reportDate').addEventListener('input', function() {
      let input = this.value.replace(/\D/g, '');
      if (input.length > 2 && input.length <= 4) {
        input = input.slice(0,2) + '/' + input.slice(2);
      } else if (input.length > 4) {
        input = input.slice(0,2) + '/' + input.slice(2,4) + '/' + input.slice(4,8);
      }
      this.value = input;
      saveDraftDate();
    });

    // Envío
    $('#paymentForm').addEventListener('submit', function(e) {
      e.preventDefault();

      const client = $('#clientName').value.trim();
      const amount = parseAmount($('#amount').value);
      const type = ($('input[name="paymentType"]:checked') || {}).value;

      if (!client || isNaN(amount) || !type) {
        customAlert('Por favor, ingresa datos válidos (cliente, importe y forma de pago).', () => {});
        return;
      }

      // Añadimos sin borrar el formulario ni el borrador (tú mandas cuándo borrar)
      history.push({ id: Date.now(), client, amount, type });
      saveHistory();
      updateUI();
      // No hacemos reset para que no se borre nada salvo que tú lo cambies
    });

    // Borrar historial con confirmación
    $('#clearHistory').addEventListener('click', function() {
      customConfirm('¿Estás seguro de borrar TODO el historial?', (ok) => {
        if (!ok) return;
        history = [];
        saveHistory();
        updateUI();
        // No tocamos ni la fecha ni el borrador del formulario
      });
    });

    // Descargar Excel
    $('#downloadExcel').addEventListener('click', function() {
      const reportDate = $('#reportDate').value.trim();
      if (!/^\d{2}\/\d{2}\/\d{4}$/.test(reportDate)) {
        customAlert('Por favor, ingresa la fecha en formato DD/MM/AAAA antes de descargar.', () => {});
        return;
      }

      const efectivoEntries = history.filter(e => e.type === 'Efectivo');
      const tarjetaEntries = history.filter(e => e.type === 'Tarjeta');
      const totalEfectivo = efectivoEntries.reduce((s, e) => s + (Number(e.amount) || 0), 0);
      const totalTarjeta = tarjetaEntries.reduce((s, e) => s + (Number(e.amount) || 0), 0);
      const totalGeneral = totalEfectivo + totalTarjeta;

      const ws_data = [];
      ws_data.push(['Liquidación diaria']);
      ws_data.push(['Fecha: ' + reportDate]);
      ws_data.push([]);
      ws_data.push(['Efectivo', '', '', 'Tarjeta', '']);
      ws_data.push(['Cliente', 'Importe', '', 'Cliente', 'Importe']);

      const maxRows = Math.max(efectivoEntries.length, tarjetaEntries.length);
      for (let i = 0; i < maxRows; i++) {
        const row = [];
        if (i < efectivoEntries.length) {
          row.push(efectivoEntries[i].client);
          row.push(Number(efectivoEntries[i].amount)); // número real
        } else { row.push(''); row.push(''); }
        row.push('');
        if (i < tarjetaEntries.length) {
          row.push(tarjetaEntries[i].client);
          row.push(Number(tarjetaEntries[i].amount)); // número real
        } else { row.push(''); row.push(''); }
        ws_data.push(row);
      }
      ws_data.push([]);
      ws_data.push(['Total Efectivo', Number(totalEfectivo), '', 'Total Tarjeta', Number(totalTarjeta)]);
      ws_data.push(['Total General', Number(totalGeneral), '', '', '']);

      const ws = XLSX.utils.aoa_to_sheet(ws_data);

      // Anchos de columna
      ws['!cols'] = [
        { wch: 25 }, { wch: 15 }, { wch: 3 }, { wch: 25 }, { wch: 15 }
      ];

      // Merges
      ws['!merges'] = [
        { s: { r:0, c:0 }, e: { r:0, c:4 } },
        { s: { r:1, c:0 }, e: { r:1, c:4 } },
        { s: { r:3, c:0 }, e: { r:3, c:1 } },
        { s: { r:3, c:3 }, e: { r:3, c:4 } }
      ];

      const wb = XLSX.utils.book_new();
      XLSX.utils.book_append_sheet(wb, ws, 'Historial');
      const safeDate = reportDate.replace(/\//g, '-');
      XLSX.writeFile(wb, 'liquidacion_' + safeDate + '.xlsx');
    });

    // Dropdowns (detalles)
    function renderDropdown(list, container) {
      clearNode(container);
      if (list.length === 0) {
        const em = document.createElement('em');
        em.textContent = 'Sin registros.';
        container.appendChild(em);
      } else {
        const ul = document.createElement('ul');
        ul.style.listStyle = 'none';
        ul.style.margin = '0';
        ul.style.padding = '0';
        list.forEach(item => {
          const li = document.createElement('li');
          li.textContent = `${item.client} — ${formatNumber(item.amount)}`;
          ul.appendChild(li);
        });
        container.appendChild(ul);
      }
    }

    function toggleDropdownEfectivo() {
      const dropdown = $('#dropdownEfectivo');
      const other = $('#dropdownTarjeta');
      if (dropdown.style.display === 'none' || dropdown.style.display === '') {
        const efectivoEntries = history.filter(e => e.type === 'Efectivo');
        renderDropdown(efectivoEntries, dropdown);
        dropdown.style.display = 'block';
        other.style.display = 'none';
      } else {
        dropdown.style.display = 'none';
      }
    }
    function toggleDropdownTarjeta() {
      const dropdown = $('#dropdownTarjeta');
      const other = $('#dropdownEfectivo');
      if (dropdown.style.display === 'none' || dropdown.style.display === '') {
        const tarjetaEntries = history.filter(e => e.type === 'Tarjeta');
        renderDropdown(tarjetaEntries, dropdown);
        dropdown.style.display = 'block';
        other.style.display = 'none';
      } else {
        dropdown.style.display = 'none';
      }
    }

    $('#totalEfectivo').addEventListener('click', toggleDropdownEfectivo);
    $('#totalTarjeta').addEventListener('click', toggleDropdownTarjeta);

    // Sincroniza si se abre en varias pestañas
    window.addEventListener('storage', (ev) => {
      if (ev.key === LS_KEYS.HISTORY) {
        loadHistory();
        updateUI();
      } else if (ev.key === LS_KEYS.DRAFT) {
        loadDraftForm();
      } else if (ev.key === LS_KEYS.DATE) {
        loadDraftDate();
      }
    });
  </script>
</body>
</html>
