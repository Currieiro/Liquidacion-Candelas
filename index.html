<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <title>Liquidación diaria</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="manifest" href="manifest.json" />
  <meta name="theme-color" content="#FFA500" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black" />
  <meta name="apple-mobile-web-app-title" content="Liquidación diaria" />
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <style>
    :root{
      --coffee:#6f4e37; --orange:#FFA500; --orange-dark:#f0a500;
      --white:#fff; --black:#000; --blue:#008CBA; --neg:#ff6b6b;
    }
    *{box-sizing:border-box}
    html,body{height:100%;margin:0;background:var(--coffee);color:var(--white);font-family:Arial,sans-serif;overscroll-behavior:none}
    .page{min-height:100vh;padding:20px}
    header{
      padding:16px 20px;background:var(--orange);color:var(--white);
      border-radius:8px;margin-bottom:16px;display:flex;align-items:center;justify-content:center;gap:12px
    }
    header img.logo{height:42px;width:auto;border-radius:4px;display:block}
    header h1{margin:0;font-size:1.6em;line-height:1}
    .container{max-width:900px;margin:0 auto}

    .date-input{margin-bottom:8px;display:flex;gap:10px;flex-wrap:wrap;align-items:center}
    .date-input input{
      padding:10px;font-size:1em;border:1px solid var(--white);border-radius:5px;background:transparent;color:var(--white);width:180px
    }

    /* Toggle de vista día/semana */
    .view-toggle{
      margin-bottom:16px;
      display:inline-flex;
      border-radius:999px;
      border:1px solid var(--white);
      overflow:hidden;
    }
    .toggle-btn{
      border:none;
      background:transparent;
      color:var(--white);
      padding:6px 12px;
      font-size:0.9em;
      cursor:pointer;
      min-width:110px;
    }
    .toggle-btn.active{
      background:var(--orange-dark);
      font-weight:bold;
    }

    .field{position:relative;flex:1 1 200px;min-width:160px}
    .field input{
      width:100%;padding:10px 72px 10px 10px;font-size:1em;border:1px solid var(--white);border-radius:5px;background:transparent;color:var(--white)
    }
    .field .clear-btn,.field .sign-btn{
      position:absolute;top:50%;transform:translateY(-50%);height:24px;min-width:24px;border:1px solid var(--white);
      color:var(--white);background:transparent;border-radius:50%;cursor:pointer;font-size:16px;display:none;align-items:center;justify-content:center;padding:0
    }
    .field .sign-btn{right:40px;display:inline-flex}
    .field .clear-btn{right:8px}

    form{display:flex;flex-wrap:wrap;gap:10px;margin-bottom:20px;align-items:center}
    .payment-method{
      display:flex;
      align-items:center;
      gap:12px;
      flex-wrap:wrap;
    }
    .payment-method label{cursor:pointer}
    .pay-row{display:flex;align-items:center;gap:12px;flex-wrap:wrap}
    .pay-row .btn-add-inline{
      padding:10px;font-size:1em;border:1px solid var(--white);
      border-radius:5px;background:var(--blue);color:var(--white);cursor:pointer
    }

    table{width:100%;border-collapse:collapse;margin-bottom:20px;background:#00000022;border-radius:8px;overflow:hidden}
    table,th,td{border:1px solid var(--white)}
    th,td{padding:10px;text-align:center}
    .editBtn{border:1px solid var(--white);background:var(--blue);color:var(--white);border-radius:5px;padding:10px;cursor:pointer}
    .neg{color:var(--neg);font-weight:600}

    /* Colores suaves por forma de pago */
    .pay-cash td:first-child{border-left:4px solid #7bd389;}
    .pay-card td:first-child{border-left:4px solid #4da6ff;}
    .pay-bizum td:first-child{border-left:4px solid #b084f5;}
    .pay-check td:first-child{border-left:4px solid #f5d76e;}

    /* Forma de pago en color (columna 4 de la tabla) */
    .pay-cash td:nth-child(4){color:#7bd389;}
    .pay-card td:nth-child(4){color:#4da6ff;}
    .pay-bizum td:nth-child(4){color:#b084f5;}
    .pay-check td:nth-child(4){color:#f5d76e;}

    .summary{
      display:flex;justify-content:space-around;gap:10px;flex-wrap:wrap;
      padding:10px;background:var(--orange-dark);border:1px solid var(--white);border-radius:5px
    }
    #totalEfectivo,#totalTarjeta,#totalBizum,#totalTalon{
      cursor:pointer;text-decoration:underline
    }
    .totalValue.neg{color:var(--neg)}

    /* Bloque de ingresos */
    .incomes-box{
      margin-top:8px;
      padding:8px 10px;
      border-radius:6px;
      background:#00000033;
      font-size:0.9em;
      display:flex;
      flex-wrap:wrap;
      gap:8px;
      align-items:center;
      justify-content:space-between;
    }
    .incomes-box strong{margin-right:6px;}
    .incomes-row{
      display:flex;
      flex-direction:column;
      gap:2px;
    }
    @media(min-width:600px){
      .incomes-row{
        flex-direction:row;
        gap:12px;
      }
    }
    #btnAddIncome{
      padding:6px 10px;
      background:var(--blue);
      border:1px solid var(--white);
      border-radius:6px;
      color:var(--white);
      cursor:pointer;
      font-size:0.85em;
      white-space:nowrap;
    }

    .buttons{display:flex;flex-wrap:wrap;gap:10px;margin-top:10px}
    .buttons button{flex:1;min-width:180px;padding:10px;background:var(--orange);border:none;color:var(--white);border-radius:5px;cursor:pointer}

    /* Sección liquidación semanal */
    .week-section{
      margin-top:16px;
      padding:10px;
      border-radius:8px;
      border:1px solid var(--white);
      background:#00000033;
      font-size:0.9em;
    }
    .week-section h3{
      margin:0 0 8px 0;
      font-size:1em;
    }
    .week-row{
      display:flex;
      align-items:center;
      gap:8px;
      flex-wrap:wrap;
      margin-bottom:6px;
    }
    .week-row label{
      min-width:52px;
    }
    .week-section input{
      padding:6px 8px;
      font-size:0.9em;
      border:1px solid var(--white);
      border-radius:5px;
      background:transparent;
      color:var(--white);
      width:120px;
    }
    .week-section .btn-weekly{
      margin-top:6px;
      width:100%;
      padding:8px;
      background:var(--blue);
      border:1px solid var(--white);
      border-radius:6px;
      color:var(--white);
      cursor:pointer;
      font-size:0.95em;
    }

    footer.footer{
      margin-top:16px;
      padding:6px 10px;
      font-size:0.85em;
      color:#f5f5f5;
      display:flex;
      justify-content:space-between;
      opacity:0.8;
    }

    .modal{display:none;position:fixed;inset:0;background:rgba(0,0,0,.5);z-index:1000}
    .modal-content{background:var(--white);color:var(--black);margin:8% auto;padding:20px;border-radius:12px;width:360px;max-width:calc(100% - 24px)}
    .modal-content h2{margin:0 0 12px 0;text-align:center}
    .modal-form{display:grid;grid-template-columns:1fr 1.5fr;gap:10px 12px;align-items:center}
    .modal-form input,.modal-form select{width:100%;padding:8px;border:1px solid #ccc;border-radius:6px}
    @media(max-width:420px){.modal-form{grid-template-columns:1fr}}
    .modal-buttons{margin-top:16px;display:flex;gap:8px;flex-wrap:wrap}
    .modal-buttons button{flex:1;padding:10px;border-radius:8px;border:1px solid #ddd;background:#fff;color:#000}
    .danger{border-color:#d9534f}.primary{border-color:#007bff}.secondary{border-color:#6c757d}

    .dropdown{display:none;margin-top:10px;border:1px solid var(--white);border-radius:5px;padding:10px;background:var(--orange-dark)}

    /* Columna hora algo más discreta */
    th.time-col, td.time-col{
      font-size:0.85em;
      color:#ddd;
      white-space:nowrap;
    }

    /* Botones ingresos tabla */
    .btn-income{
      padding:4px 6px;
      font-size:0.8em;
      border-radius:4px;
      border:1px solid var(--white);
      background:var(--blue);
      color:var(--white);
      cursor:pointer;
      margin:0 2px;
    }
  </style>
</head>
<body>
  <div class="page">
    <header>
      <img src="logo-candelas.jpg" alt="Logo Candelas" class="logo">
      <h1>Liquidación diaria</h1>
    </header>

    <div class="container">
      <!-- Fecha -->
      <div class="date-input">
        <label for="reportDate">Fecha (DD/MM/AAAA):</label>
        <input type="text" id="reportDate" placeholder="DD/MM/AAAA" maxlength="10" inputmode="numeric" autocomplete="off">
      </div>

      <!-- Toggle vista -->
      <div class="view-toggle">
        <button type="button" class="toggle-btn active" id="btnViewDay">Vista diaria</button>
        <button type="button" class="toggle-btn" id="btnViewWeek">Vista semanal</button>
      </div>

      <!-- Formulario -->
      <form id="paymentForm" autocomplete="off">
        <div class="field">
          <input type="text" id="clientName" placeholder="Nombre del cliente" autocomplete="off" required>
          <button class="clear-btn" id="clearClient" type="button" aria-label="Limpiar cliente">×</button>
        </div>

        <div class="field">
          <input type="text" id="amount" placeholder="Importe cobrado" autocomplete="off"
                 inputmode="decimal" pattern="-?[0-9]*[.,]?[0-9]*" required>
          <button class="sign-btn" id="toggleSign" type="button" aria-label="Cambiar signo">±</button>
          <button class="clear-btn" id="clearAmount" type="button" aria-label="Limpiar importe">×</button>
        </div>

        <!-- Formas de pago + Agregar -->
        <div class="pay-row">
          <div class="payment-method">
            <label><input type="radio" name="paymentType" value="Efectivo"> Efectivo</label>
            <label><input type="radio" name="paymentType" value="Tarjeta"> Tarjeta</label>
            <label><input type="radio" name="paymentType" value="Bizum"> Bizum</label>
            <label><input type="radio" name="paymentType" value="Talón"> Talón</label>
          </div>
          <button class="btn-add-inline" type="submit">Agregar</button>
        </div>
      </form>

      <!-- Tabla cobros -->
      <table id="historyTable">
        <thead>
          <tr>
            <th>Cliente</th>
            <th class="time-col">Hora</th>
            <th>Importe</th>
            <th>Forma de pago</th>
            <th>Acciones</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>

      <!-- Resumen -->
      <div class="summary">
        <div><strong>Efectivo:</strong> <span id="totalEfectivo" class="totalValue">0,00</span></div>
        <div><strong>Tarjeta:</strong> <span id="totalTarjeta" class="totalValue">0,00</span></div>
        <div><strong>Bizum:</strong> <span id="totalBizum" class="totalValue">0,00</span></div>
        <div><strong>Talón:</strong> <span id="totalTalon" class="totalValue">0,00</span></div>
        <div><strong>Total:</strong> <span id="totalGeneral" class="totalValue">0,00</span></div>
      </div>

      <!-- Ingresos -->
      <div class="incomes-box">
        <strong>Ingresos</strong>
        <div class="incomes-row">
          <span>Total ingresado (semana): <span id="totalIngresos">0,00</span></span>
          <span>Pendiente de ingresar (semana): <span id="totalPendiente" class="totalValue">0,00</span></span>
        </div>
        <button id="btnAddIncome" type="button">Añadir ingreso</button>
      </div>

      <!-- Tabla ingresos (editable) -->
      <table id="incomesTable">
        <thead>
          <tr>
            <th>Fecha</th>
            <th>Hora</th>
            <th>Importe</th>
            <th>Acciones</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>

      <!-- Dropdowns -->
      <div id="dropdownEfectivo" class="dropdown"></div>
      <div id="dropdownTarjeta" class="dropdown"></div>
      <div id="dropdownBizum" class="dropdown"></div>
      <div id="dropdownTalon" class="dropdown"></div>

      <!-- Botones -->
      <div class="buttons">
        <button id="downloadExcel">Descargar / Compartir Excel</button>
        <button id="clearHistory">Borrar Historial</button>
      </div>

      <!-- Liquidación semanal -->
      <div class="week-section">
        <h3>Liquidación semanal</h3>
        <div class="week-row">
          <label>Inicio:</label>
          <input type="text" id="weekStartDate" placeholder="DD/MM/AAAA" maxlength="10" inputmode="numeric">
          <input type="text" id="weekStartTime" placeholder="HH:MM" maxlength="5" inputmode="numeric">
        </div>
        <div class="week-row">
          <label>Fin:</label>
          <input type="text" id="weekEndDate" placeholder="DD/MM/AAAA" maxlength="10" inputmode="numeric">
          <input type="text" id="weekEndTime" placeholder="HH:MM" maxlength="5" inputmode="numeric">
        </div>
        <button id="downloadWeekly" class="btn-weekly">Descargar Excel semanal</button>
      </div>

      <!-- Versión -->
      <footer class="footer">
        <span>Versión <span id="appVersion"></span></span>
        <span id="appRevision"></span>
      </footer>
    </div>
  </div>

  <!-- Modal edición cobro -->
  <div id="editModal" class="modal">
    <div class="modal-content">
      <h2>Editar entrada</h2>
      <div class="modal-form">
        <label for="editClient">Cliente</label>
        <input type="text" id="editClient" />
        <label for="editTime">Hora</label>
        <input type="text" id="editTime" placeholder="HH:MM" inputmode="numeric" />
        <label for="editAmount">Importe</label>
        <input type="text" id="editAmount" inputmode="decimal" pattern="-?[0-9]*[.,]?[0-9]*" />
        <label for="editPayment">Forma de pago</label>
        <select id="editPayment">
          <option value="Efectivo">Efectivo</option>
          <option value="Tarjeta">Tarjeta</option>
          <option value="Bizum">Bizum</option>
          <option value="Talón">Talón</option>
        </select>
      </div>
      <div class="modal-buttons">
        <button id="deleteLine" class="danger">Eliminar línea</button>
        <button id="saveEdit" class="primary">Guardar</button>
        <button id="cancelEdit" class="secondary">Cancelar</button>
      </div>
    </div>
  </div>

  <!-- Modal ingresos (alta/edición) -->
  <div id="incomeModal" class="modal">
    <div class="modal-content">
      <h2>Ingreso</h2>
      <div class="modal-form">
        <label for="incomeDate">Fecha</label>
        <input type="text" id="incomeDate" placeholder="DD/MM/AAAA" maxlength="10" inputmode="numeric" />
        <label for="incomeTime">Hora</label>
        <input type="text" id="incomeTime" placeholder="HH:MM" maxlength="5" inputmode="numeric" />
        <label for="incomeAmount">Importe</label>
        <input type="text" id="incomeAmount" inputmode="decimal" pattern="-?[0-9]*[.,]?[0-9]*" />
      </div>
      <div class="modal-buttons">
        <button id="deleteIncome" class="danger">Eliminar ingreso</button>
        <button id="saveIncome" class="primary">Guardar</button>
        <button id="cancelIncome" class="secondary">Cancelar</button>
      </div>
    </div>
  </div>

  <!-- Confirmación -->
  <div id="confirmModal" class="modal">
    <div class="modal-content">
      <p id="confirmMessage">¿Seguro?</p>
      <div class="modal-buttons">
        <button id="confirmAccept" class="primary">Aceptar</button>
        <button id="confirmCancel" class="secondary">Cancelar</button>
      </div>
    </div>
  </div>

  <!-- Alerta -->
  <div id="alertModal" class="modal">
    <div class="modal-content">
      <p id="alertMessage">Mensaje</p>
      <div class="modal-buttons">
        <button id="alertAccept" class="primary">Aceptar</button>
      </div>
    </div>
  </div>

<script>
/* === Versión automática === */
const APP_BASE_VERSION = '1.5';
function computeAppVersion() {
  const d = new Date(document.lastModified || Date.now());
  const yy = String(d.getFullYear()).slice(-2);
  const mm = String(d.getMonth() + 1).padStart(2,'0');
  const dd = String(d.getDate()).padStart(2,'0');
  const hh = String(d.getHours()).padStart(2,'0');
  const min = String(d.getMinutes()).padStart(2,'0');
  return `${APP_BASE_VERSION}.${yy}${mm}${dd}${hh}${min}`;
}
const APP_VERSION = computeAppVersion();

/* === Helpers === */
const $=s=>document.querySelector(s); const $$=s=>Array.from(document.querySelectorAll(s));
function formatNumber(n){return Number(n||0).toFixed(2).replace('.',',');}
function parseAmount(v){
  if(v==null)return NaN;
  const c=String(v).trim().replace(',', '.');
  if(!/^[-+]?\d*\.?\d*$/.test(c)) return NaN;
  return parseFloat(c);
}
function setNegColor(el,v){Number(v)<0?el.classList.add('neg'):el.classList.remove('neg');}
function getCurrentTimeStr(){
  const d=new Date();
  const hh=String(d.getHours()).padStart(2,'0');
  const mm=String(d.getMinutes()).padStart(2,'0');
  return `${hh}:${mm}`;
}
function getTodayKey(){
  const d=new Date();
  const yyyy=d.getFullYear();
  const mm=String(d.getMonth()+1).padStart(2,'0');
  const dd=String(d.getDate()).padStart(2,'0');
  return `${yyyy}-${mm}-${dd}`;
}
function setDefaultReportDateIfEmpty(){
  const input = $('#reportDate');
  if(!input) return;
  if(!input.value){
    const d=new Date();
    const dd=String(d.getDate()).padStart(2,'0');
    const mm=String(d.getMonth()+1).padStart(2,'0');
    const yyyy=d.getFullYear();
    input.value = `${dd}/${mm}/${yyyy}`;
  }
}
function parseDateToParts(str){ // DD/MM/AAAA -> {yyyy,mm,dd} o null
  const m = /^(\d{2})\/(\d{2})\/(\d{4})$/.exec(str.trim());
  if(!m) return null;
  const dd = parseInt(m[1],10);
  const mm = parseInt(m[2],10);
  const yyyy = parseInt(m[3],10);
  const d = new Date(yyyy,mm-1,dd);
  if(d.getFullYear()!==yyyy || d.getMonth()!==mm-1 || d.getDate()!==dd) return null;
  return {yyyy,mm,dd};
}
function parseTimeToParts(str){ // HH:MM -> {hh,mi} o null
  const m=/^(\d{1,2}):(\d{2})$/.exec(str.trim());
  if(!m) return null;
  const hh=parseInt(m[1],10);
  const mi=parseInt(m[2],10);
  if(hh<0||hh>23||mi<0||mi>59) return null;
  return {hh,mi};
}
function formatDateFromDate(d){
  const dd=String(d.getDate()).padStart(2,'0');
  const mm=String(d.getMonth()+1).padStart(2,'0');
  const yyyy=d.getFullYear();
  return `${dd}/${mm}/${yyyy}`;
}
function formatTimeFromDate(d){
  const hh=String(d.getHours()).padStart(2,'0');
  const mi=String(d.getMinutes()).padStart(2,'0');
  return `${hh}:${mi}`;
}
function formatDateFromKey(key){
  if(!key) return '';
  const [yyyy,mm,dd]=key.split('-');
  return `${dd}/${mm}/${yyyy}`;
}
function getCurrentDateKey(){
  const input = $('#reportDate');
  if(!input) return null;
  const parts = parseDateToParts(input.value);
  if(!parts) return null;
  const {yyyy,mm,dd}=parts;
  return `${yyyy}-${String(mm).padStart(2,'0')}-${String(dd).padStart(2,'0')}`;
}
function tsFromKeyAndTime(key,timeStr){
  let yyyy,mm,dd;
  if(key){
    const parts = key.split('-');
    yyyy=parseInt(parts[0],10);
    mm=parseInt(parts[1],10);
    dd=parseInt(parts[2],10);
  }else{
    const now=new Date();
    yyyy=now.getFullYear();
    mm=now.getMonth()+1;
    dd=now.getDate();
  }
  let hh=12,mi=0;
  const tParts = timeStr && parseTimeToParts(timeStr);
  if(tParts){hh=tParts.hh;mi=tParts.mi;}
  return new Date(yyyy,mm-1,dd,hh,mi,0,0).getTime();
}
function addDateMask(input){
  if(!input) return;
  input.addEventListener('input',function(){
    let v=this.value.replace(/\D/g,'');
    if(v.length>2&&v.length<=4) v=v.slice(0,2)+'/'+v.slice(2);
    else if(v.length>4) v=v.slice(0,2)+'/'+v.slice(2,4)+'/'+v.slice(4,8);
    this.value=v;
  });
}
/* Máscara de hora HH:MM sobre teclado numérico */
function addTimeMask(input){
  if(!input) return;
  input.addEventListener('input', function(){
    let v = this.value.replace(/\D/g,'');
    if(v.length<=2){
      this.value = v;
    }else{
      this.value = v.slice(0,2)+':'+v.slice(2,4);
    }
  });
}

/* === Estado === */
let historyData=[];let currentEditIndex=null;let revision=0;
let viewMode='day'; // 'day' | 'week'
let incomesData=[];
let currentIncomeIndex = null;

/* === Rango semanal (para vista y Excel semanal) === */
function getWeeklyRange(){
  const sDateStr = $('#weekStartDate')?.value.trim() || '';
  const sTimeStr = $('#weekStartTime')?.value.trim() || '';
  const eDateStr = $('#weekEndDate')?.value.trim() || '';
  const eTimeStr = $('#weekEndTime')?.value.trim() || '';

  const sDateParts = parseDateToParts(sDateStr);
  const eDateParts = parseDateToParts(eDateStr);
  const sTimeParts = parseTimeToParts(sTimeStr);
  const eTimeParts = parseTimeToParts(eTimeStr);

  if(!sDateParts || !eDateParts || !sTimeParts || !eTimeParts) return null;

  const startTs = new Date(
    sDateParts.yyyy, sDateParts.mm-1, sDateParts.dd,
    sTimeParts.hh, sTimeParts.mi, 0,0
  ).getTime();
  const endTs = new Date(
    eDateParts.yyyy, eDateParts.mm-1, eDateParts.dd,
    eTimeParts.hh, eTimeParts.mi, 0,0
  ).getTime();

  if(endTs<=startTs) return null;
  return {startTs,endTs};
}

/* === Carga de historial y migración === */
function loadHistory(){
  try{
    historyData=JSON.parse(localStorage.getItem('history')||'[]');
    if(!Array.isArray(historyData))historyData=[];
  }catch{historyData=[]}

  const todayKey = getTodayKey();
  let changed=false;
  historyData.forEach(e=>{
    if(!e.dateKey){
      e.dateKey = todayKey;
      changed=true;
    }
    if(typeof e.ts!=='number'){
      e.ts = tsFromKeyAndTime(e.dateKey, e.time || '12:00');
      changed=true;
    }
  });
  if(changed){
    localStorage.setItem('history',JSON.stringify(historyData));
  }

  const storedVersion = localStorage.getItem('appVersion');
  if(storedVersion !== APP_VERSION){
    revision = 0;
    localStorage.setItem('appVersion', APP_VERSION);
    localStorage.setItem('dataRevision', String(revision));
  } else {
    revision = Number(localStorage.getItem('dataRevision')||'0')||0;
  }
}
function saveHistory(){localStorage.setItem('history',JSON.stringify(historyData));}

function loadIncomes(){
  try{
    incomesData = JSON.parse(localStorage.getItem('incomes') || '[]');
    if(!Array.isArray(incomesData)) incomesData=[];
  }catch{incomesData=[];}

  let changed=false;
  incomesData.forEach(e=>{
    if(!e.dateKey && e.date){
      const parts = parseDateToParts(e.date);
      if(parts){
        const {yyyy,mm,dd}=parts;
        e.dateKey = `${yyyy}-${String(mm).padStart(2,'0')}-${String(dd).padStart(2,'0')}`;
        changed=true;
      }
    }
    if(typeof e.ts!=='number'){
      const key = e.dateKey || getTodayKey();
      e.ts = tsFromKeyAndTime(key, e.time || '12:00');
      changed=true;
    }
  });
  if(changed) saveIncomes();
}
function saveIncomes(){localStorage.setItem('incomes', JSON.stringify(incomesData));}

function updateVersionUI(){
  const vEl = $('#appVersion');
  const rEl = $('#appRevision');
  if(vEl) vEl.textContent = APP_VERSION;
  if(rEl) rEl.textContent = 'Rev. '+revision;
}
function bumpRevision(){
  revision++;
  localStorage.setItem('dataRevision', String(revision));
  updateVersionUI();
}
function clearNode(n){while(n.firstChild)n.removeChild(n.firstChild);}

/* === Datos visibles (según vista) === */
function getVisibleData(){
  if(viewMode==='week'){
    const range = getWeeklyRange();
    if(!range) return [];
    const {startTs,endTs} = range;
    return historyData.filter(e=>typeof e.ts==='number' && e.ts>startTs && e.ts<=endTs);
  }
  const key = getCurrentDateKey();
  if(!key) return historyData;
  return historyData.filter(e=>e.dateKey===key);
}
function getVisibleIncomes(){
  if(viewMode==='week'){
    const range = getWeeklyRange();
    if(!range) return [];
    const {startTs,endTs} = range;
    return incomesData.filter(e=>typeof e.ts==='number' && e.ts>startTs && e.ts<=endTs);
  }
  const key = getCurrentDateKey();
  if(!key) return incomesData;
  return incomesData.filter(e=>e.dateKey===key);
}

/* === Resumen de ingresos: SIEMPRE semanal cuando haya rango válido === */
function updateIncomeSummary(totalEfectivoVisible){
  const elTI = $('#totalIngresos');
  const elTP = $('#totalPendiente');
  if(!elTI || !elTP) return;

  const range = getWeeklyRange();
  let totalIngreso = 0;
  let baseEfectivo = 0;

  if(range){
    const {startTs,endTs} = range;
    totalIngreso = incomesData
      .filter(e=>typeof e.ts==='number' && e.ts>startTs && e.ts<=endTs)
      .reduce((s,e)=>s+(+e.amount||0),0);
    baseEfectivo = historyData
      .filter(e=>e.type==='Efectivo' && typeof e.ts==='number' && e.ts>startTs && e.ts<=endTs)
      .reduce((s,e)=>s+(+e.amount||0),0);
  }else{
    // Fallback: si el rango semanal no es válido, usamos la vista actual
    const list = getVisibleIncomes();
    totalIngreso = list.reduce((s,e)=>s+(+e.amount||0),0);
    baseEfectivo = totalEfectivoVisible;
  }

  const pendiente = baseEfectivo - totalIngreso;

  elTI.textContent = formatNumber(totalIngreso);
  elTP.textContent = formatNumber(pendiente);
  setNegColor(elTP, pendiente);
}

/* === Tabla de ingresos === */
function updateIncomesTable(){
  const tb = $('#incomesTable tbody');
  if(!tb) return;
  clearNode(tb);
  const visible = getVisibleIncomes();
  visible.forEach(inc=>{
    const tr = document.createElement('tr');

    const tdD = document.createElement('td');
    tdD.textContent = formatDateFromKey(inc.dateKey);

    const tdH = document.createElement('td');
    tdH.textContent = inc.time || '';

    const tdA = document.createElement('td');
    tdA.textContent = formatNumber(inc.amount);
    setNegColor(tdA, inc.amount);

    const tdAct = document.createElement('td');
    const idx = incomesData.indexOf(inc);

    const btnE = document.createElement('button');
    btnE.type='button';
    btnE.className='btn-income';
    btnE.textContent='Editar';
    btnE.dataset.i = idx;

    tdAct.appendChild(btnE);

    tr.append(tdD,tdH,tdA,tdAct);
    tb.appendChild(tr);
  });

  $$('.btn-income').forEach(b=>{
    b.onclick=()=>{
      const i = Number(b.dataset.i);
      openIncomeModal(i);
    };
  });
}

/* === UI diaria/semanal cobros === */
function updateUI(){
  const tb=$('#historyTable tbody');clearNode(tb);
  const visibleData = getVisibleData();
  let tE=0,tT=0,tB=0,tL=0;

  const typeClasses = {
    'Efectivo':'pay-cash',
    'Tarjeta':'pay-card',
    'Bizum':'pay-bizum',
    'Talón':'pay-check'
  };

  visibleData.forEach((e)=>{
    const tr=document.createElement('tr');
    const tdC=document.createElement('td');tdC.textContent=e.client;
    const tdH=document.createElement('td');tdH.textContent=e.time || ''; tdH.className='time-col';
    const tdA=document.createElement('td');tdA.textContent=formatNumber(e.amount);setNegColor(tdA,e.amount);
    const tdT=document.createElement('td');tdT.textContent=e.type;
    const tdAct=document.createElement('td');const btn=document.createElement('button');
    btn.type='button';btn.className='editBtn';btn.textContent='Editar';
    tdAct.appendChild(btn);
    tr.append(tdC,tdH,tdA,tdT,tdAct);

    const cls = typeClasses[e.type];
    if(cls) tr.classList.add(cls);

    tb.appendChild(tr);

    switch(e.type){
      case 'Efectivo': tE+=+e.amount; break;
      case 'Tarjeta': tT+=+e.amount; break;
      case 'Bizum':   tB+=+e.amount; break;
      case 'Talón':   tL+=+e.amount; break;
    }
  });

  const elTE=$('#totalEfectivo'),
        elTT=$('#totalTarjeta'),
        elTB=$('#totalBizum'),
        elTL=$('#totalTalon'),
        elTG=$('#totalGeneral');

  elTE.textContent=formatNumber(tE); setNegColor(elTE,tE);
  elTT.textContent=formatNumber(tT); setNegColor(elTT,tT);
  elTB.textContent=formatNumber(tB); setNegColor(elTB,tB);
  elTL.textContent=formatNumber(tL); setNegColor(elTL,tL);

  const totalGeneral = tE+tT+tB+tL;
  elTG.textContent=formatNumber(totalGeneral); setNegColor(elTG,totalGeneral);

  // Ingresos (siempre semanal si rango válido)
  updateIncomeSummary(tE);
  updateIncomesTable();

  const allRows = Array.from(tb.children);
  const visible = visibleData;
  $$('.editBtn').forEach((b)=>{
    b.onclick=()=>{
      const row = b.closest('tr');
      const idx = allRows.indexOf(row);
      const realItem = visible[idx];
      const realIndex = historyData.indexOf(realItem);
      currentEditIndex = realIndex;
      openEditModal(currentEditIndex);
    };
  });
}

/* === Modales genéricos === */
function customConfirm(msg,cb){
  $('#confirmMessage').textContent=msg;
  const m=$('#confirmModal');m.style.display='block';
  const a=$('#confirmAccept'),c=$('#confirmCancel');
  function clean(){a.onclick=c.onclick=null;m.style.display='none'}
  a.onclick=()=>{clean();cb(true)};
  c.onclick=()=>{clean();cb(false)};
}
function customAlert(msg,cb){
  $('#alertMessage').textContent=msg;
  const m=$('#alertModal');m.style.display='block';
  $('#alertAccept').onclick=()=>{m.style.display='none';if(cb)cb();};
}

/* === Editar cobro === */
function openEditModal(i){
  const e=historyData[i]; if(!e) return;
  $('#editClient').value=e.client;
  $('#editTime').value=e.time || '';
  $('#editAmount').value=e.amount;
  $('#editPayment').value=e.type;
  $('#editModal').style.display='block';
}
function closeEditModal(){$('#editModal').style.display='none';currentEditIndex=null;}

$('#saveEdit').onclick=()=>{
  const c=$('#editClient').value.trim();
  const h=$('#editTime').value.trim();
  const a=parseAmount($('#editAmount').value);
  const t=$('#editPayment').value;
  if(!c||isNaN(a)){customAlert('Datos inválidos');return;}
  const old = historyData[currentEditIndex] || {};
  const dateKey = old.dateKey || getTodayKey();
  const ts = tsFromKeyAndTime(dateKey,h || old.time || '12:00');
  historyData[currentEditIndex]={client:c,amount:a,type:t,time:h,dateKey,ts};
  saveHistory();updateUI();closeEditModal();bumpRevision();
};
$('#cancelEdit').onclick=closeEditModal;
$('#deleteLine').onclick=()=>{
  const e=historyData[currentEditIndex]; if(!e) return;
  customConfirm(`¿Eliminar "${e.client}" (${formatNumber(e.amount)} - ${e.type})?`, ok=>{
    if(!ok) return;
    historyData.splice(currentEditIndex,1);
    saveHistory(); updateUI(); closeEditModal(); bumpRevision();
  });
};

/* === Ingresos: alta/edición === */
function openIncomeModal(index=null){
  currentIncomeIndex = index;
  const dateInput = $('#incomeDate');
  const timeInput = $('#incomeTime');
  const amountInput = $('#incomeAmount');
  const deleteBtn = $('#deleteIncome');

  if(index!==null && incomesData[index]){
    const inc = incomesData[index];
    dateInput.value = formatDateFromKey(inc.dateKey);
    timeInput.value = inc.time || '';
    amountInput.value = inc.amount;
    deleteBtn.style.display = 'inline-flex';
  }else{
    const now = new Date();
    let defaultDate = $('#reportDate')?.value.trim() || '';
    if(!parseDateToParts(defaultDate)){
      defaultDate = formatDateFromDate(now);
    }
    dateInput.value = defaultDate;
    timeInput.value = getCurrentTimeStr();
    amountInput.value = '';
    deleteBtn.style.display = 'none';
  }
  $('#incomeModal').style.display='block';
}
function closeIncomeModal(){
  $('#incomeModal').style.display='none';
  currentIncomeIndex = null;
}
$('#btnAddIncome').onclick=()=>openIncomeModal(null);
$('#cancelIncome').onclick=closeIncomeModal;

$('#saveIncome').onclick=()=>{
  const dStr = $('#incomeDate').value.trim();
  const tStr = $('#incomeTime').value.trim();
  const a = parseAmount($('#incomeAmount').value);

  const dParts = parseDateToParts(dStr);
  const tParts = parseTimeToParts(tStr);
  if(!dParts || !tParts || isNaN(a)){
    customAlert('Datos de ingreso inválidos.');
    return;
  }
  const {yyyy,mm,dd} = dParts;
  const dateKey = `${yyyy}-${String(mm).padStart(2,'0')}-${String(dd).padStart(2,'0')}`;
  const ts = new Date(yyyy,mm-1,dd,tParts.hh,tParts.mi,0,0).getTime();

  const obj = {amount:a,dateKey,time:tStr,ts};
  if(currentIncomeIndex===null){
    incomesData.push(obj);
  }else{
    incomesData[currentIncomeIndex]=obj;
  }
  saveIncomes();
  updateUI();
  bumpRevision();
  closeIncomeModal();
};

$('#deleteIncome').onclick=()=>{
  if(currentIncomeIndex===null || !incomesData[currentIncomeIndex]){ 
    closeIncomeModal(); 
    return; 
  }
  const inc = incomesData[currentIncomeIndex];
  customConfirm(`¿Eliminar ingreso de ${formatDateFromKey(inc.dateKey)} ${inc.time || ''} (${formatNumber(inc.amount)})?`, ok=>{
    if(!ok) return;
    incomesData.splice(currentIncomeIndex,1);
    saveIncomes();
    updateUI();
    bumpRevision();
    closeIncomeModal();
  });
};

/* === Formulario cobros === */
const clientInput=$('#clientName'); const amountInput=$('#amount');
const clearClientBtn=$('#clearClient'); const clearAmountBtn=$('#clearAmount'); const toggleSignBtn=$('#toggleSign');

function toggleClearBtn(i,b){b.style.display=i.value?'inline-flex':'none';}
clientInput.oninput=()=>toggleClearBtn(clientInput,clearClientBtn);
amountInput.oninput=()=>toggleClearBtn(amountInput,clearAmountBtn);
clearClientBtn.onclick=()=>{clientInput.value='';toggleClearBtn(clientInput,clearClientBtn);clientInput.focus();}
clearAmountBtn.onclick=()=>{amountInput.value='';toggleClearBtn(amountInput,clearAmountBtn);amountInput.focus();}
toggleSignBtn.onclick=()=>{
  let v=amountInput.value.trim();
  if(!v){amountInput.value='-';amountInput.focus();return;}
  amountInput.value=v.startsWith('-')?v.slice(1):'-'+v;
  amountInput.focus(); toggleClearBtn(amountInput,clearAmountBtn);
};

$('#paymentForm').onsubmit=e=>{
  e.preventDefault();
  const c=clientInput.value.trim();
  const a=parseAmount(amountInput.value);
  const t=document.querySelector('input[name="paymentType"]:checked')?.value;
  if(!c||isNaN(a)||!t){customAlert('Faltan datos válidos');return;}

  const key = getCurrentDateKey() || getTodayKey();
  const timeStr = getCurrentTimeStr();
  const ts = tsFromKeyAndTime(key,timeStr);
  historyData.push({client:c,amount:a,type:t,time:timeStr,dateKey:key,ts});
  saveHistory(); updateUI(); bumpRevision();

  e.target.reset();
  clientInput.value=''; amountInput.value='';
  toggleClearBtn(clientInput,clearClientBtn); toggleClearBtn(amountInput,clearAmountBtn);

  clientInput.blur(); amountInput.blur();
  if (document.activeElement && typeof document.activeElement.blur === 'function') {
    document.activeElement.blur();
  }
};

/* === Borrar historial cobros (no borra ingresos) === */
$('#clearHistory').onclick=()=>customConfirm('¿Borrar historial de cobros?', ok=>{
  if(ok){
    historyData=[];
    saveHistory();
    updateUI();
    const dateInput = $('#reportDate');
    if(dateInput) dateInput.value = '';
    setDefaultReportDateIfEmpty();
    updateUI();
    bumpRevision();
  }
});

/* === Máscara de fecha diaria === */
addDateMask($('#reportDate'));
$('#reportDate').addEventListener('change',()=>{
  if(viewMode==='day'){
    updateUI();
    hideAllDropdowns();
  }
});

/* === Excel diario (solo cobros de la fecha seleccionada) === */
function isShareSupported(file){return navigator.share&&navigator.canShare&&navigator.canShare({files:[file]});}
$('#downloadExcel').onclick=async()=>{
  const dStr=$('#reportDate').value.trim();
  if(!parseDateToParts(dStr)){
    customAlert('Fecha inválida. Formato: DD/MM/AAAA.');
    return;
  }

  const dayKey = getCurrentDateKey();
  const dayData = dayKey ? historyData.filter(e=>e.dateKey===dayKey) : historyData;

  const allTypes = ['Efectivo','Tarjeta','Bizum','Talón'];
  const activeTypes = allTypes.filter(type => dayData.some(e=>e.type===type));
  if(activeTypes.length===0){
    customAlert('No hay datos para exportar en esta fecha.');
    return;
  }

  const groups = {};
  const totals = {};
  activeTypes.forEach(type=>{
    const list = dayData.filter(e=>e.type===type);
    groups[type] = list;
    totals[type] = list.reduce((s,e)=>s+(+e.amount||0),0);
  });
  const totalGeneral = activeTypes.reduce((s,type)=>s+totals[type],0);

  const ws_data = [];
  ws_data.push(['Liquidación diaria']);
  ws_data.push(['Fecha: '+dStr]);
  ws_data.push([]);

  // Fila de tipos en mayúsculas, con columna separadora
  const typeRow = [];
  activeTypes.forEach(type=>{
    typeRow.push(type.toUpperCase(),'','','');
  });
  ws_data.push(typeRow);

  // Fila Cliente / Importe / Hora + separador
  const headerRow = [];
  activeTypes.forEach(()=>{
    headerRow.push('Cliente','Importe','Hora','');
  });
  ws_data.push(headerRow);

  // Datos
  const maxLen = Math.max(...activeTypes.map(t=>groups[t].length));
  for(let i=0;i<maxLen;i++){
    const row = [];
    activeTypes.forEach(type=>{
      const item = groups[type][i];
      if(item){
        row.push(item.client, Number(item.amount), item.time || '', '');
      }else{
        row.push('','','','');
      }
    });
    ws_data.push(row);
  }

  ws_data.push([]);

  // Totales por tipo
  const totalsRow = [];
  activeTypes.forEach(type=>{
    totalsRow.push('Total '+type, Number(totals[type]), '', '');
  });
  ws_data.push(totalsRow);

  // Total general
  const totalCols = activeTypes.length*4;
  const totalGeneralRow = [];
  totalGeneralRow.push('Total General', Number(totalGeneral));
  while(totalGeneralRow.length<totalCols) totalGeneralRow.push('');
  ws_data.push(totalGeneralRow);

  const wb=XLSX.utils.book_new();
  const ws=XLSX.utils.aoa_to_sheet(ws_data);

  // Anchos de columnas
  const cols=[];
  for(let i=0;i<totalCols;i++){
    const mod=i%4;
    if(mod===0) cols.push({wch:18});   // Cliente
    else if(mod===1) cols.push({wch:12}); // Importe
    else if(mod===2) cols.push({wch:8});  // Hora
    else cols.push({wch:4});           // separador
  }
  ws['!cols']=cols;

  // Merges para títulos y tipos
  const merges = [
    {s:{r:0,c:0},e:{r:0,c:totalCols-1}}, // título
    {s:{r:1,c:0},e:{r:1,c:totalCols-1}}  // fecha
  ];
  activeTypes.forEach((type,idx)=>{
    const startCol = idx*4;
    merges.push({s:{r:3,c:startCol},e:{r:3,c:startCol+2}});
  });
  ws['!merges']=merges;

  // Formato numérico: siempre dos decimales
  const range = XLSX.utils.decode_range(ws['!ref']);
  for(let R=0; R<=range.e.r; ++R){
    for(let C=0; C<=range.e.c; ++C){
      const addr = XLSX.utils.encode_cell({r:R,c:C});
      const cell = ws[addr];
      if(cell && typeof cell.v === 'number'){
        cell.z = '0.00';
      }
    }
  }

  XLSX.utils.book_append_sheet(wb,ws,'Historial');

  const blob=new Blob(
    [XLSX.write(wb,{bookType:'xlsx',type:'array',cellStyles:true})],
    {type:'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet'}
  );
  const fileName='liquidacion_'+dStr.replace(/\//g,'-')+'.xlsx';
  const file=new File([blob],fileName,{type:blob.type});

  try{
    if(isShareSupported(file)){
      await navigator.share({files:[file],title:'Liquidación diaria',text:fileName});
      return;
    }
  }catch(_){}

  const url=URL.createObjectURL(blob);
  const a=document.createElement('a'); a.href=url; a.download=fileName; a.click();
  setTimeout(()=>URL.revokeObjectURL(url),1500);
};

/* === Dropdowns === */
function fillDropdown(list,node){
  clearNode(node);
  if(!list.length){
    const em=document.createElement('em');
    em.textContent='Sin registros.';
    node.appendChild(em);
    return;
  }
  const ul=document.createElement('ul');
  ul.style.listStyle='none';
  ul.style.margin='0';
  ul.style.padding='0';
  list.forEach(it=>{
    const li=document.createElement('li');
    const span=document.createElement('span');
    span.textContent=`${it.client} — ${formatNumber(it.amount)}`;
    if(Number(it.amount)<0) span.classList.add('neg');
    li.appendChild(span);
    ul.appendChild(li);
  });
  node.appendChild(ul);
}
function hideAllDropdowns(){
  ['dropdownEfectivo','dropdownTarjeta','dropdownBizum','dropdownTalon'].forEach(id=>{
    const el=document.getElementById(id);
    if(el) el.style.display='none';
  });
}

$('#totalEfectivo').onclick=()=>{
  const d=$('#dropdownEfectivo');
  const isOpen=d.style.display==='block';
  hideAllDropdowns();
  if(!isOpen){
    const visible = getVisibleData();
    fillDropdown(visible.filter(e=>e.type==='Efectivo'), d);
    d.style.display='block';
  }
};
$('#totalTarjeta').onclick=()=>{
  const d=$('#dropdownTarjeta');
  const isOpen=d.style.display==='block';
  hideAllDropdowns();
  if(!isOpen){
    const visible = getVisibleData();
    fillDropdown(visible.filter(e=>e.type==='Tarjeta'), d);
    d.style.display='block';
  }
};
$('#totalBizum').onclick=()=>{
  const d=$('#dropdownBizum');
  const isOpen=d.style.display==='block';
  hideAllDropdowns();
  if(!isOpen){
    const visible = getVisibleData();
    fillDropdown(visible.filter(e=>e.type==='Bizum'), d);
    d.style.display='block';
  }
};
$('#totalTalon').onclick=()=>{
  const d=$('#dropdownTalon');
  const isOpen=d.style.display==='block';
  hideAllDropdowns();
  if(!isOpen){
    const visible = getVisibleData();
    fillDropdown(visible.filter(e=>e.type==='Talón'), d);
    d.style.display='block';
  }
};

/* === Guardar ajustes de rango semanal === */
function saveWeeklySettings(){
  const sD = $('#weekStartDate')?.value.trim() || '';
  const sT = $('#weekStartTime')?.value.trim() || '';
  const eD = $('#weekEndDate')?.value.trim() || '';
  const eT = $('#weekEndTime')?.value.trim() || '';
  localStorage.setItem('weekStartDate', sD);
  localStorage.setItem('weekStartTime', sT);
  localStorage.setItem('weekEndDate', eD);
  localStorage.setItem('weekEndTime', eT);
}

/* === Liquidación semanal: inicialización === */
function initWeeklySection(){
  const startDateEl=$('#weekStartDate');
  const startTimeEl=$('#weekStartTime');
  const endDateEl=$('#weekEndDate');
  const endTimeEl=$('#weekEndTime');
  if(!startDateEl || !startTimeEl || !endDateEl || !endTimeEl) return;

  const savedStartDate = localStorage.getItem('weekStartDate');
  const savedStartTime = localStorage.getItem('weekStartTime');
  const savedEndDate   = localStorage.getItem('weekEndDate');
  const savedEndTime   = localStorage.getItem('weekEndTime');

  const now = new Date();
  let startDateStr, startTimeStr, endDateStr, endTimeStr;

  if(
    savedStartDate && savedStartTime && savedEndDate && savedEndTime &&
    parseDateToParts(savedStartDate) && parseDateToParts(savedEndDate) &&
    parseTimeToParts(savedStartTime) && parseTimeToParts(savedEndTime)
  ){
    startDateStr = savedStartDate;
    startTimeStr = savedStartTime;
    endDateStr   = savedEndDate;
    endTimeStr   = savedEndTime;
  }else{
    const lastTsStr = localStorage.getItem('lastClosingTs');
    let start = now;
    if(lastTsStr && !isNaN(Number(lastTsStr))){
      start = new Date(Number(lastTsStr));
    }else{
      start = new Date(now.getFullYear(),now.getMonth(),now.getDate(),0,0,0,0);
    }
    startDateStr = formatDateFromDate(start);
    startTimeStr = formatTimeFromDate(start);
    endDateStr   = formatDateFromDate(now);
    endTimeStr   = formatTimeFromDate(now);
  }

  startDateEl.value = startDateStr;
  startTimeEl.value = startTimeStr;
  endDateEl.value   = endDateStr;
  endTimeEl.value   = endTimeStr;

  addDateMask(startDateEl);
  addDateMask(endDateEl);
  addTimeMask(startTimeEl);
  addTimeMask(endTimeEl);
}

/* === Excel semanal (incluye ingresos) === */
$('#downloadWeekly').onclick=async()=>{
  const sDateStr = $('#weekStartDate').value.trim();
  const sTimeStr = $('#weekStartTime').value.trim();
  const eDateStr = $('#weekEndDate').value.trim();
  const eTimeStr = $('#weekEndTime').value.trim();

  const sDateParts = parseDateToParts(sDateStr);
  const eDateParts = parseDateToParts(eDateStr);
  const sTimeParts = parseTimeToParts(sTimeStr);
  const eTimeParts = parseTimeToParts(eTimeStr);

  if(!sDateParts || !eDateParts || !sTimeParts || !eTimeParts){
    customAlert('Fechas/horas de liquidación semanal no válidas.');
    return;
  }

  const startTs = new Date(
    sDateParts.yyyy, sDateParts.mm-1, sDateParts.dd,
    sTimeParts.hh, sTimeParts.mi, 0,0
  ).getTime();
  const endTs = new Date(
    eDateParts.yyyy, eDateParts.mm-1, eDateParts.dd,
    eTimeParts.hh, eTimeParts.mi, 0,0
  ).getTime();

  if(endTs<=startTs){
    customAlert('La fecha/hora de fin debe ser posterior al inicio.');
    return;
  }

  const weekData = historyData.filter(e=>typeof e.ts==='number' && e.ts>startTs && e.ts<=endTs);
  if(weekData.length===0){
    customAlert('No hay datos en ese rango de fechas/horas.');
    return;
  }

  const allTypes = ['Efectivo','Tarjeta','Bizum','Talón'];
  const activeTypes = allTypes.filter(type => weekData.some(e=>e.type===type));
  if(activeTypes.length===0){
    customAlert('No hay datos en ese rango para las formas de pago.');
    return;
  }

  const groups = {};
  const totals = {};
  activeTypes.forEach(type=>{
    const list = weekData.filter(e=>e.type===type);
    groups[type] = list;
    totals[type] = list.reduce((s,e)=>s+(+e.amount||0),0);
  });
  const totalGeneral = activeTypes.reduce((s,type)=>s+totals[type],0);

  // Ingresos en el mismo rango
  const incomesInRange = incomesData.filter(e=>typeof e.ts==='number' && e.ts>startTs && e.ts<=endTs);
  const totalIngresos = incomesInRange.reduce((s,e)=>s+(+e.amount||0),0);
  const totalEfectivoSemana = totals['Efectivo'] || 0;
  const diferencia = totalEfectivoSemana - totalIngresos;

  const ws_data = [];
  ws_data.push(['Liquidación semanal']);
  ws_data.push([`Desde: ${sDateStr} ${sTimeStr}   Hasta: ${eDateStr} ${eTimeStr}`]);
  ws_data.push([]);

  // Fila de tipos en mayúsculas, con columna separadora
  const typeRow = [];
  activeTypes.forEach(type=>{
    typeRow.push(type.toUpperCase(),'','','');
  });
  ws_data.push(typeRow);

  // Fila Cliente / Importe / Hora + separador
  const headerRow = [];
  activeTypes.forEach(()=>{
    headerRow.push('Cliente','Importe','Hora','');
  });
  ws_data.push(headerRow);

  // Datos
  const maxLen = Math.max(...activeTypes.map(t=>groups[t].length));
  for(let i=0;i<maxLen;i++){
    const row = [];
    activeTypes.forEach(type=>{
      const item = groups[type][i];
      if(item){
        row.push(item.client, Number(item.amount), item.time || '', '');
      }else{
        row.push('','','','');
      }
    });
    ws_data.push(row);
  }

  ws_data.push([]);

  // Totales por tipo
  const totalsRow = [];
  activeTypes.forEach(type=>{
    totalsRow.push('Total '+type, Number(totals[type]), '', '');
  });
  ws_data.push(totalsRow);

  // Total general
  const totalCols = activeTypes.length*4;
  const totalGeneralRow = [];
  totalGeneralRow.push('Total General', Number(totalGeneral));
  while(totalGeneralRow.length<totalCols) totalGeneralRow.push('');
  ws_data.push(totalGeneralRow);

  // Resumen efectivo / ingresos
  ws_data.push([]);
  ws_data.push(['Total Efectivo', Number(totalEfectivoSemana)]);
  ws_data.push(['Total Ingreso', Number(totalIngresos)]);
  if(Math.abs(diferencia) > 0.00001){
    ws_data.push(['Diferencia', Number(diferencia)]);
  }

  const wb=XLSX.utils.book_new();
  const ws=XLSX.utils.aoa_to_sheet(ws_data);

  // Anchos de columnas
  const cols=[];
  for(let i=0;i<totalCols;i++){
    const mod=i%4;
    if(mod===0) cols.push({wch:18});   // Cliente
    else if(mod===1) cols.push({wch:12}); // Importe
    else if(mod===2) cols.push({wch:8});  // Hora
    else cols.push({wch:4});           // separador
  }
  ws['!cols']=cols;

  // Merges para títulos y tipos
  const merges = [
    {s:{r:0,c:0},e:{r:0,c:totalCols-1}}, // título
    {s:{r:1,c:0},e:{r:1,c:totalCols-1}}  // rango fechas
  ];
  activeTypes.forEach((type,idx)=>{
    const startCol = idx*4;
    merges.push({s:{r:3,c:startCol},e:{r:3,c:startCol+2}});
  });
  ws['!merges']=merges;

  // Formato numérico: siempre dos decimales
  const range = XLSX.utils.decode_range(ws['!ref']);
  for(let R=0; R<=range.e.r; ++R){
    for(let C=0; C<=range.e.c; ++C){
      const addr = XLSX.utils.encode_cell({r:R,c:C});
      const cell = ws[addr];
      if(cell && typeof cell.v === 'number'){
        cell.z = '0.00';
      }
    }
  }

  XLSX.utils.book_append_sheet(wb,ws,'Semanal');

  const blob=new Blob(
    [XLSX.write(wb,{bookType:'xlsx',type:'array',cellStyles:true})],
    {type:'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet'}
  );

  const sKey = `${sDateParts.yyyy}-${String(sDateParts.mm).padStart(2,'0')}-${String(sDateParts.dd).padStart(2,'0')}`;
  const eKey = `${eDateParts.yyyy}-${String(eDateParts.mm).padStart(2,'0')}-${String(eDateParts.dd).padStart(2,'0')}`;
  const fileName='liquidacion_semanal_'+sKey+'_a_'+eKey+'.xlsx';
  const file=new File([blob],fileName,{type:blob.type});

  try{
    if(isShareSupported(file)){
      await navigator.share({files:[file],title:'Liquidación semanal',text:fileName});
    }else{
      const url=URL.createObjectURL(blob);
      const a=document.createElement('a'); a.href=url; a.download=fileName; a.click();
      setTimeout(()=>URL.revokeObjectURL(url),1500);
    }
  }catch(_){
    const url=URL.createObjectURL(blob);
    const a=document.createElement('a'); a.href=url; a.download=fileName; a.click();
    setTimeout(()=>URL.revokeObjectURL(url),1500);
  }

  // Guardar este fin como último cierre y como nuevo inicio por defecto
  localStorage.setItem('lastClosingTs', String(endTs));
  $('#weekStartDate').value = eDateStr;
  $('#weekStartTime').value = eTimeStr;
  saveWeeklySettings();
};

/* === Vista día/semana: botones y cambios === */
const btnDay = $('#btnViewDay');
const btnWeek = $('#btnViewWeek');

if(btnDay && btnWeek){
  btnDay.onclick=()=>{
    viewMode='day';
    btnDay.classList.add('active');
    btnWeek.classList.remove('active');
    updateUI();
    hideAllDropdowns();
  };
  btnWeek.onclick=()=>{
    const range=getWeeklyRange();
    if(!range){
      customAlert('Revisa la fecha y hora de inicio y fin de la liquidación semanal.');
      return;
    }
    viewMode='week';
    btnWeek.classList.add('active');
    btnDay.classList.remove('active');
    updateUI();
    hideAllDropdowns();
  };
}

/* Cuando cambian fechas/horas de semana, guardamos y si vista semanal, refrescamos */
['weekStartDate','weekStartTime','weekEndDate','weekEndTime'].forEach(id=>{
  const el=document.getElementById(id);
  if(id==='weekStartDate' || id==='weekEndDate') addDateMask(el);
  if(id==='weekStartTime' || id==='weekEndTime') addTimeMask(el);
  if(el){
    el.addEventListener('change',()=>{
      saveWeeklySettings();
      if(viewMode==='week'){
        updateUI();
        hideAllDropdowns();
      }
    });
  }
});

/* === Start === */
loadHistory();
loadIncomes();
setDefaultReportDateIfEmpty();
updateUI();
updateVersionUI();
toggleClearBtn($('#clientName'), $('#clearClient'));
toggleClearBtn($('#amount'), $('#clearAmount'));
addTimeMask($('#editTime'));
addDateMask($('#incomeDate'));
addTimeMask($('#incomeTime'));
initWeeklySection();
</script>
</body>
</html>
